<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Fitting Room</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(120% 120% at 50% 0%, #1e2433 0%, #0c0e16 55%, #07080f 100%);
      color: #e6e9f2;
      overflow: hidden;
    }
    #app {
      position: fixed;
      inset: 0;
    }
    #canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    #hud {
      position: absolute;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      padding: 12px 16px;
      background: rgba(9, 11, 18, 0.72);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }
    #hud.visible {
      opacity: 1;
      pointer-events: auto;
    }
    #welcome-overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 50%;
      height: 100%;
      background: rgba(9, 11, 18, 0.95);
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px;
      box-sizing: border-box;
      transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
    }
    #welcome-overlay.slide-out {
      transform: translateX(-100%);
    }
    /* Mobile styles - full screen layout */
    @media (max-width: 768px) {
      #welcome-overlay {
        width: 100%;
      }
      #welcome-overlay.slide-out {
        display: none;
      }
      /* Mobile: position arrows at screen edges */
      .arrow-controls {
        width: 100%;
      }
      .arrow-btn.left {
        left: 10px !important;
        right: auto !important;
      }
      .arrow-btn.right {
        right: 10px !important;
        left: auto !important;
      }
      /* Keep individual clothing type vertical positions */
      .arrow-controls.shirts {
        top: 25%;
      }
      .arrow-controls.pants {
        top: 45%;
      }
      .arrow-controls.shoes {
        top: 65%;
      }
      .arrow-controls.dresses {
        top: 35%;
      }
    }
    /* iPad portrait - full screen layout (like mobile) */
    @media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
      #welcome-overlay {
        width: 100%;
      }
      #welcome-overlay.slide-out {
        display: none;
      }
      /* iPad portrait: position arrows at screen edges */
      .arrow-controls {
        width: 100%;
      }
      .arrow-btn.left {
        left: 10px !important;
        right: auto !important;
      }
      .arrow-btn.right {
        right: 10px !important;
        left: auto !important;
      }
      /* Keep individual clothing type vertical positions */
      .arrow-controls.shirts {
        top: 25%;
      }
      .arrow-controls.pants {
        top: 45%;
      }
      .arrow-controls.shoes {
        top: 65%;
      }
      .arrow-controls.dresses {
        top: 35%;
      }
    }
    #welcome-content {
      text-align: center;
      max-width: 400px;
    }
    #welcome-content h1 {
      font-size: 48px;
      font-weight: 700;
      margin: 0 0 20px 0;
      background: linear-gradient(135deg, #9fb3ff 0%, #6a85ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    #welcome-content p {
      font-size: 18px;
      color: rgba(230, 233, 242, 0.8);
      margin: 0 0 40px 0;
      line-height: 1.6;
    }
    #welcome-buttons {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
    }
    #welcome-buttons.two-buttons {
      flex-direction: row;
      gap: 20px;
      max-width: 400px;
    }
    .welcome-button {
      background: linear-gradient(135deg, #3f5efb 0%, #6a85ff 100%);
      border: none;
      color: #fff;
      padding: 16px 48px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
      box-shadow: 0 10px 30px rgba(82, 114, 255, 0.4);
      width: 100%;
    }
    .welcome-button.hidden {
      opacity: 0;
      pointer-events: none;
      width: 0;
      padding: 16px 0;
      margin: 0;
    }
    .welcome-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(82, 114, 255, 0.5);
    }
    .welcome-button:active {
      transform: translateY(0);
    }
    /* Legacy go-button styling for compatibility */
    #go-button {
      background: linear-gradient(135deg, #3f5efb 0%, #6a85ff 100%);
      border: none;
      color: #fff;
      padding: 16px 48px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 30px rgba(82, 114, 255, 0.4);
    }
    #go-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(82, 114, 255, 0.5);
    }
    #go-button:active {
      transform: translateY(0);
    }
    .arrow-controls {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }
    .arrow-controls.visible {
      opacity: 1;
      pointer-events: auto;
    }
    /* On desktop, hide arrows initially until button is clicked, except dresses */
    @media (min-width: 769px) {
      .arrow-controls:not(.show-after-click):not(.dresses) {
        opacity: 0 !important;
        pointer-events: none !important;
      }
      .arrow-controls.show-after-click.visible {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      /* Dresses arrows always visible on desktop */
      .arrow-controls.dresses.visible {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
    }
    .arrow-btn {
      position: absolute;
      width: 56px;
      height: 56px;
      background: none;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0;
    }
    .arrow-btn:hover {
      transform: scale(1.2);
    }
    .arrow-btn:active {
      transform: scale(1.1);
      transition: all 0.1s ease;
    }
    /* Modern chevron arrows using CSS - grey sleek color */
    .arrow-btn.left::before,
    .arrow-btn.right::before {
      content: '';
      display: block;
      width: 18px;
      height: 18px;
      border-top: 3px solid rgba(180, 180, 180, 0.85);
      border-right: 3px solid rgba(180, 180, 180, 0.85);
      margin: auto;
      transition: all 0.3s ease;
    }
    .arrow-btn.left::before {
      transform: rotate(-135deg);
    }
    .arrow-btn.right::before {
      transform: rotate(45deg);
    }
    .arrow-btn:hover::before {
      border-color: rgba(220, 220, 220, 1);
      border-width: 3.5px;
    }
    .arrow-btn.left:hover::before {
      transform: rotate(-135deg) translateX(-3px);
    }
    .arrow-btn.right:hover::before {
      transform: rotate(45deg) translateX(3px);
    }
    /* Desktop: position arrows with consistent spacing from center (responsive to viewport) */
    .arrow-btn.left {
      left: calc(50% - 180px);
    }
    .arrow-btn.right {
      right: calc(50% - 180px);
    }
    /* iPad landscape: wider spacing for better usability */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
      .arrow-btn.left {
        left: calc(50% - 220px);
      }
      .arrow-btn.right {
        right: calc(50% - 220px);
      }
    }
    /* Medium screens (770-900px): wider spacing to prevent arrows being too close */
    @media (min-width: 770px) and (max-width: 900px) {
      .arrow-btn.left {
        left: calc(50% - 160px);
      }
      .arrow-btn.right {
        right: calc(50% - 160px);
      }
    }
    /* Tablet: slightly closer spacing */
    @media (max-width: 769px) {
      .arrow-btn.left {
        left: calc(50% - 100px);
      }
      .arrow-btn.right {
        right: calc(50% - 100px);
      }
    }
    /* Mobile: position arrows at screen edges */
    @media (max-width: 768px) {
      .arrow-btn.left {
        left: 10px !important;
        right: auto !important;
      }
      .arrow-btn.right {
        right: 10px !important;
        left: auto !important;
      }
    }
    .arrow-btn.single {
      left: 50%;
      transform: translateX(-50%);
    }
    /* Position arrow controls for each clothing type - closer to center where clothes are */
    .arrow-controls.shirts {
      top: 25%;
      left: 0;
      right: 0;
    }
    .arrow-controls.pants {
      top: 45%;
      left: 0;
      right: 0;
    }
    .arrow-controls.shoes {
      top: 65%;
      left: 0;
      right: 0;
    }
    .arrow-controls.dresses {
      top: 35%;
      left: 0;
      right: 0;
    }
    #mode-button {
      position: absolute;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: linear-gradient(135deg, #3f5efb 0%, #6a85ff 100%);
      border: none;
      color: #fff;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease, transform 0.2s ease;
      box-shadow: 0 10px 30px rgba(82, 114, 255, 0.4);
    }
    #mode-button.visible {
      opacity: 1;
      pointer-events: auto;
    }
    #mode-button:hover {
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 15px 40px rgba(82, 114, 255, 0.5);
    }
    #mode-button:active {
      transform: translateX(-50%) translateY(0);
    }
    #back-button {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background: rgba(63, 94, 251, 0.8);
      border: none;
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease, background 0.2s ease;
      z-index: 200;
    }
    #back-button.visible {
      opacity: 1;
      pointer-events: auto;
    }
    #back-button:hover {
      background: rgba(63, 94, 251, 1);
    }
    .arrow-controls.styles {
      top: 30%;
      left: 0;
      right: 0;
    }
    /* Filter selection screen */
    #filter-overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 50%;
      height: 100%;
      background: rgba(9, 11, 18, 0.95);
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      padding: 40px;
      box-sizing: border-box;
      z-index: 150;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      overflow-y: auto;
    }
    #filter-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 768px) {
      #filter-overlay {
        width: 100%;
      }
    }
    /* iPad portrait - full screen filter overlay */
    @media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
      #filter-overlay {
        width: 100%;
      }
    }
    #filter-content {
      max-width: 500px;
      margin: 0 auto;
      width: 100%;
    }
    #filter-content h2 {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 30px 0;
      background: linear-gradient(135deg, #9fb3ff 0%, #6a85ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    /* Center filter text on smaller devices */
    @media (max-width: 768px) {
      #filter-content {
        text-align: center;
      }
      #filter-content h2 {
        text-align: center;
      }
      .filter-category h3 {
        text-align: center;
      }
    }
    /* Center filter text on iPad portrait */
    @media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
      #filter-content {
        text-align: center;
      }
      #filter-content h2 {
        text-align: center;
      }
      .filter-category h3 {
        text-align: center;
      }
    }
    .filter-category {
      margin-bottom: 40px;
    }
    .filter-category h3 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 20px 0;
      color: #e6e9f2;
    }
    .filter-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 16px;
    }
    .filter-option {
      aspect-ratio: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #e6e9f2;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      text-align: center;
    }
    .filter-option:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    .filter-option.selected {
      background: linear-gradient(135deg, #3f5efb 0%, #6a85ff 100%);
      border-color: #6a85ff;
      color: #fff;
      box-shadow: 0 4px 15px rgba(106, 133, 255, 0.4);
    }
    .filter-option-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .filter-option-title {
      font-size: 14px;
      font-weight: 500;
      margin: 0;
    }
    #apply-filters-button {
      margin-top: 30px;
      padding: 16px 48px;
      background: linear-gradient(135deg, #3f5efb 0%, #6a85ff 100%);
      border: none;
      color: #fff;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 30px rgba(82, 114, 255, 0.4);
      width: 100%;
    }
    #apply-filters-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(82, 114, 255, 0.5);
    }
    #apply-filters-button:active {
      transform: translateY(0);
    }
    /* Toast removed */
  </style>
</head>
<body>
  <div id="app">
    <canvas id="canvas"></canvas>
    <div id="welcome-overlay">
      <div id="welcome-content">
        <h1>Welcome</h1>
        <p>Experience our 3D fitting room. Explore different styles and see how they look together.</p>
        <div id="welcome-buttons" class="two-buttons">
          <button class="welcome-button" id="free-browse-button">Free Browse</button>
          <button class="welcome-button" id="specific-button">Specific</button>
        </div>
      </div>
    </div>
    <div class="arrow-controls shirts visible" data-type="shirts" id="shirts-controls">
      <button class="arrow-btn left" data-type="shirts" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="shirts" data-dir="1"></button>
      </div>
    <div class="arrow-controls pants visible" data-type="pants">
      <button class="arrow-btn left" data-type="pants" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="pants" data-dir="1"></button>
      </div>
    <div class="arrow-controls shoes visible" data-type="shoes">
      <button class="arrow-btn left" data-type="shoes" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="shoes" data-dir="1"></button>
      </div>
    <div class="arrow-controls dresses" data-type="dresses" style="display: none;">
      <button class="arrow-btn left" data-type="dresses" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="dresses" data-dir="1"></button>
    </div>
    <button id="mode-button">Dresses</button>
    <button id="back-button">‚Üê Back</button>
    <div class="arrow-controls styles" data-type="styles" id="styles-controls" style="display: none;">
      <button class="arrow-btn left" data-type="styles" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="styles" data-dir="1"></button>
    </div>
    <div id="filter-overlay">
      <div id="filter-content">
        <h2>Filter Clothing</h2>
        <div class="filter-category">
          <h3>Tops</h3>
          <div class="filter-options" id="tops-options">
            <button class="filter-option" data-filter="shirt">
              <div class="filter-option-icon">üëï</div>
              <div class="filter-option-title">Shirts</div>
            </button>
            <button class="filter-option" data-filter="jacket">
              <div class="filter-option-icon">üß•</div>
              <div class="filter-option-title">Jackets</div>
            </button>
          </div>
        </div>
        <div class="filter-category">
          <h3>Bottoms</h3>
          <div class="filter-options" id="bottoms-options">
            <button class="filter-option" data-filter="shorts">
              <div class="filter-option-icon">ü©≥</div>
              <div class="filter-option-title">Shorts</div>
            </button>
            <button class="filter-option" data-filter="skirt">
              <div class="filter-option-icon">üëó</div>
              <div class="filter-option-title">Skirts</div>
            </button>
            <button class="filter-option" data-filter="jeans">
              <div class="filter-option-icon">üëñ</div>
              <div class="filter-option-title">Jeans</div>
            </button>
            <button class="filter-option" data-filter="leggings">
              <div class="filter-option-icon">üß¶</div>
              <div class="filter-option-title">Leggings</div>
            </button>
            <button class="filter-option" data-filter="pants">
              <div class="filter-option-icon">üëî</div>
              <div class="filter-option-title">Pants</div>
            </button>
          </div>
        </div>
        <div class="filter-category">
          <h3>Shoes</h3>
          <div class="filter-options" id="shoes-options">
            <button class="filter-option" data-filter="basketball">
              <div class="filter-option-icon">üèÄ</div>
              <div class="filter-option-title">Basketball</div>
            </button>
            <button class="filter-option" data-filter="tennis">
              <div class="filter-option-icon">üéæ</div>
              <div class="filter-option-title">Tennis</div>
            </button>
            <button class="filter-option" data-filter="dress">
              <div class="filter-option-icon">üë†</div>
              <div class="filter-option-title">Dress</div>
            </button>
            <button class="filter-option" data-filter="other">
              <div class="filter-option-icon">üëü</div>
              <div class="filter-option-title">Other</div>
            </button>
          </div>
        </div>
        <button id="apply-filters-button">Apply Filters</button>
      </div>
    </div>
  </div>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
      }
    }
    </script>
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";
    import { RoomEnvironment } from "https://unpkg.com/three@0.160.0/examples/jsm/environments/RoomEnvironment.js";

    // Assets manifest - inline dictionary (no separate file needed)
    const manifest = {
      shirts: [
        "shirt1.glb",
        "shirt2.glb",
        "shirt4.glb",
        "shirt5.glb",
        "jacket.glb",
        "jacket2.glb",
        "jacket5.glb",
        "jacket6.glb",
        "jacket9.glb"
      ],
      pants: [
        "WDressPants1.glb",
        "pant1.glb",
        "pant2.glb",
        "pant3.glb",
        "pant4.glb",
        "WDressPants2.glb",
        "WLeggings1.glb",
        "WLeggings2.glb",
        "MDressPants1.glb",
        "MDressPants2.glb",
        "wjeans1.glb",
        "wjeans2.glb",
        "wjeans3.glb",
        "mjeans1.glb",
        "mjeans2.glb",
        "mjeans3.glb"
      ],
      shoes: [
        "object_0-13.glb",
        "object_0-15.glb",
        "dressmensShoes.glb",
        "dresswomensshoes.glb",
        "dresswomensshoes2.glb",
        "WTennisShoes1.glb",
        "MBasketBallShoes1.glb",
        "MTennisShoes1.glb",

      ],
      dresses: [
        "wdress1.glb",
        "wdress2.glb",
        "wdress3.glb"
      ],
      shorts: [
        "MShorts1.glb",
        "MShorts2.glb",
        "WShorts1.glb",
        "WShorts2.glb",
        "WSkirt1.glb",
        "WSkirt2.glb"
      ]
    };
    const BASE = new URL(".", window.location.href); // e.g. https://shrishchou.github.io/YC_Fashion/

    function u(path) {
      return new URL(path.replace(/^\/+/, ""), BASE).toString(); // strips any leading /
    }

    const assets = {
      shirts:  (manifest.shirts  ?? []).map(f => u(`shirts/${f}`)),
      pants:   (manifest.pants   ?? []).map(f => u(`pants/${f}`))
                .concat((manifest.shorts ?? []).map(f => u(`shorts/${f}`))),
      shoes:   (manifest.shoes   ?? []).map(f => u(`shoes/${f}`)),
      dresses: (manifest.dresses ?? []).map(f => u(`dresses/${f}`)),
    };
    
    // Store original asset order (deep copy for later randomization)
    const originalAssets = {
      shirts: [...assets.shirts],
      pants: [...assets.pants],
      shoes: [...assets.shoes],
      dresses: [...assets.dresses]
    };
    
    // Helper to check if an item is a short
    function isShort(filepath) {
      return filepath.includes('/shorts/');
    }
    
    // Build asset paths from manifest dictionary
    const pantsItems = manifest.pants ? manifest.pants.map(file => `/pants/${file}`) : [];
    const shortsItems = manifest.shorts ? manifest.shorts.map(file => `/shorts/${file}`) : [];
    
    // Build full paths from manifest
    // const assets = {
    //   shirts: manifest.shirts ? manifest.shirts.map(file => `/shirts/${file}`) : [],
    //   pants: [...pantsItems, ...shortsItems], // Combine pants and shorts
    //   shoes: manifest.shoes ? manifest.shoes.map(file => `/shoes/${file}`) : [],
    //   dresses: manifest.dresses ? manifest.dresses.map(file => `/dresses/${file}`) : []
    // };
    
    console.log("Loaded assets from manifest:", assets);

    const verticalOffsets = {
      shoes: 1.2,      // raised up more
      pants: 2.4,      // noticeably above shoes (includes shorts)
      shirts: 4.5,     // noticeably above pants
      dresses: 2.8,    // lower position (was 3.45)
    };

    const zOffsets = {
      shoes: 0.12,      // raised up more
      pants: 0,        // noticeably above shoes (includes shorts)
      shirts: 0,       // noticeably above pants
      dresses: 0,      // same z as other items
    };

    // Mobile detection (needed for positioning)
    // Include iPad portrait (768-1024px width in portrait orientation) as mobile behavior
    const isIPadPortrait = window.innerWidth >= 769 && window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768 || isIPadPortrait;

    // Position constants
    // On mobile, start from left; on desktop, start from right
    const rightCenterX = 2.5; // initial position (on the right side of screen - desktop)
    const leftCenterX = -2.5; // initial position (on the left side of screen - mobile)
    const targetCenterX = 0; // final center position
    const rightCenterY = -0.5; // initial Y position (lower when on the right)
    const leftCenterY = -0.5; // initial Y position (lower when on the left)
    const targetCenterY = 0; // final Y position (normal center height)
    
    // Set initial position based on device type
    const initialX = isMobile ? leftCenterX : rightCenterX;
    const initialY = isMobile ? leftCenterY : rightCenterY;

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x090b12, 12, 30);

    const canvas = document.getElementById("canvas");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.1;
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    const camera = new THREE.PerspectiveCamera(25, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, 7.5, 14);
    scene.add(camera);

    const pmrem = new THREE.PMREMGenerator(renderer);
    scene.environment = pmrem.fromScene(new RoomEnvironment(renderer), 0.02).texture;

    const controls = new OrbitControls(camera, renderer.domElement);
    // Keep camera looking at center initially, items will be on the right
    controls.target.set(0, 3.4, 0);
    controls.enableDamping = true;
    controls.minDistance = 4;
    controls.maxDistance = 14;
    controls.maxPolarAngle = Math.PI * 0.55;
    
    // Store initial camera and controls state for back animation
    const initialCameraPosition = new THREE.Vector3(0, 7.5, 14);
    const initialControlsTarget = new THREE.Vector3(0, 3.4, 0);

    const hemiLight = new THREE.HemisphereLight(0x8fb2ff, 0x0b0d14, 0.75);
    hemiLight.position.set(0, 6, 0);
    scene.add(hemiLight);

    const keyLight = new THREE.DirectionalLight(0xffffff, 1.35);
    keyLight.position.set(6, 8, 8);
    keyLight.castShadow = true;
    keyLight.shadow.mapSize.set(2048, 2048);
    keyLight.shadow.bias = -0.0005;
    scene.add(keyLight);

    const rimLight = new THREE.DirectionalLight(0x96b3ff, 0.5);
    rimLight.position.set(-5, 4, -4);
    scene.add(rimLight);

    const loader = new GLTFLoader();
    const current = { shirts: 0, pants: 0, shoes: 0, dresses: 0 };
    
    // Mode state: 'casual' (shirts+pants), 'dresses', or 'styles'
    let currentMode = 'casual';
    
    // Navigation state tracking
    let navigationState = 'welcome'; // 'welcome', 'browse', 'specific-menu', 'style', 'clothing-items', 'clothing-items-filter'
    
    // Filter state
    let selectedFilters = {
      tops: [],
      bottoms: [],
      shoes: []
    };
    
    // Store last applied filters to remember them when going back
    let lastAppliedFilters = {
      tops: [],
      bottoms: [],
      shoes: []
    };
    
    // Pre-defined style combinations (5 styles with random pairs)
    const styleCombinations = [
      { shirt: 0, pant: 0, shoe: 0 },
      { shirt: 6, pant: 12, shoe: 0 },  // Style 1: Random mix
      { shirt: 1, pant: 8, shoe: 0 }, // Style 2: Random mix
      { shirt: 4, pant: 2, shoe: 1 }, // Style 3: Random mix
       // Style 4: Random mix
      { shirt: 2, pant: 1, shoe: 0 },
      { shirt: 0, pant: 2, shoe: 5 } 
      
    ];
    let currentStyleIndex = 0;
    
    // Carousel structure: each type has 3 slots (prev, current, next)
    const carouselSlots = {
      shirts: { prev: new THREE.Group(), current: new THREE.Group(), next: new THREE.Group() },
      pants: { prev: new THREE.Group(), current: new THREE.Group(), next: new THREE.Group() },
      shoes: { prev: new THREE.Group(), current: new THREE.Group(), next: new THREE.Group() },
      dresses: { prev: new THREE.Group(), current: new THREE.Group(), next: new THREE.Group() }
    };
    
    // Carousel configuration - must be declared before use
    // The pivot point is behind the current item, and items rotate around this pivot
    const CAROUSEL_PIVOT_BACK = 4.5; // How far behind the center item the pivot should be (larger = pivot further back)
    const CAROUSEL_RADIUS = CAROUSEL_PIVOT_BACK; // Distance from pivot to items (should match pivot distance for proper centering)
    const CAROUSEL_ANGLE = Math.PI / 4.5; // ~40 degrees between items (~20 degrees each side)
    const CAROUSEL_SCALE_SIDE = 0.75; // Scale for prev/next items
    
    // Carousel groups - each type has its own carousel group that rotates
    const carouselGroups = {
      shirts: new THREE.Group(),
      pants: new THREE.Group(),
      shoes: new THREE.Group(),
      dresses: new THREE.Group()
    };
    
      // Add all slots to their respective carousel groups
      Object.keys(carouselSlots).forEach(type => {
        carouselGroups[type].add(
          carouselSlots[type].prev,
          carouselSlots[type].current,
          carouselSlots[type].next
        );
        // Position the pivot point behind the center item
        // The pivot is at the carouselGroup origin
        // We want: center item at world z ‚âà 0, pivot at world z = -CAROUSEL_PIVOT_BACK (behind center)
        // Center item is positioned at (0, 0, CAROUSEL_RADIUS) relative to pivot
        // So: group.position.z = -CAROUSEL_PIVOT_BACK
        // Then center at world z = -CAROUSEL_PIVOT_BACK + CAROUSEL_RADIUS
        // For center at z = 0: CAROUSEL_RADIUS = CAROUSEL_PIVOT_BACK
        // But we use CAROUSEL_RADIUS for spacing, so ensure they match for proper centering
        carouselGroups[type].position.z = -CAROUSEL_PIVOT_BACK;
      });
    
    // Legacy groups for backward compatibility with welcome animation
    const groups = { 
      shirts: carouselGroups.shirts, 
      pants: carouselGroups.pants,
      shoes: carouselGroups.shoes,
      dresses: carouselGroups.dresses
    };
    
    // Master group to hold all clothing for easy translation and rotation
    const clothingGroup = new THREE.Group();
    clothingGroup.add(groups.shirts, groups.pants, groups.shoes, groups.dresses);
    scene.add(clothingGroup);
    
    // Initial position: right-center (translated to the right and lower)
    clothingGroup.position.x = initialX;
    clothingGroup.position.y = initialY;
    
    // Rotation state - start from 0, continuously rotating at the right position
    let rotationSpeed = 0.005; // radians per frame
    let currentRotation = 0;
    let isRotating = true;
    clothingGroup.rotation.y = 0; // Start at rotation 0 (starting position)
    
    // Normalize rotation to prevent accumulation beyond one rotation
    const MAX_ROTATION = Math.PI * 2; // one full rotation

    // Toast notifications removed - no longer showing
    function showToast(message) {
      // Toast functionality disabled
      console.log(message); // Log to console instead
    }

    function separateShoes(object) {
      // Collect all mesh objects that could be shoes
      const meshes = [];
      object.traverse((child) => {
        if (child.isMesh) {
          meshes.push(child);
        }
      });

      // If we have 2 or more meshes, try to separate them
      if (meshes.length >= 2) {
        // Calculate bounding boxes for each mesh
        const boxes = meshes.map((mesh) => {
          const box = new THREE.Box3().setFromObject(mesh);
          return { mesh, box, center: box.getCenter(new THREE.Vector3()) };
        });

        // Sort by x position (left to right)
        boxes.sort((a, b) => a.center.x - b.center.x);

        // Calculate the overall width
        const overallBox = new THREE.Box3().setFromObject(object);
        const overallWidth = overallBox.max.x - overallBox.min.x;

        // Separate the shoes horizontally
        const separation = Math.max(0.8, overallWidth * 0.4); // at least 0.8 units apart
        const leftShoe = boxes[0];
        const rightShoe = boxes[boxes.length - 1];

        // Move left shoe left, right shoe right
        if (leftShoe.mesh.parent) {
          leftShoe.mesh.position.x -= separation / 2;
        }
        if (rightShoe.mesh.parent && rightShoe.mesh !== leftShoe.mesh) {
          rightShoe.mesh.position.x += separation / 2;
        }
      }
    }

    function centerAndPlace(object, type, slot = 'current', url = '', index = -1) {
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      object.position.sub(center); // center model at origin

      // Shoes no longer need separation - keep as single model

      // For dresses, adjust vertical offset based on index
      let yOffset;
      if (type === "dresses") {
        if (index === 0) {
          // First dress - keep at current lower position
          yOffset = verticalOffsets[type] - box.min.y + 0.25;
        } else {
          // Second and third dresses - position higher up
          const higherOffset = verticalOffsets[type] + 0.4; // Add extra height
          yOffset = higherOffset - box.min.y + 0.25;
        }
      } else {
        yOffset = verticalOffsets[type] - box.min.y + 0.25; // keep a small gap from the "ground"
      }
      
      object.position.y += yOffset;

      // scale overall, but make shoes significantly smaller
      // Check if pants item is actually a short and scale it down
      let scaleTarget = 1.0;
      let zAdjustment = zOffsets[type]; // Start with base z offset
      
      if (type === "shoes") {
        // Scale down dresswomensshoes slightly more than other shoes
        if (url.toLowerCase().includes('dresswomensshoes')) {
          scaleTarget = 0.4; // Slightly smaller than regular shoes (0.5)
        } else {
          scaleTarget = 0.5;
        }
      } else if (type === "pants") {
        // Check if this is a short based on file path
        const isAShort = isShort(url);
        scaleTarget = isAShort ? 0.6 : 1.2; // Shorts scaled down, pants normal
        object.position.y += isAShort ? 0.7:0;
      } else if (type === "dresses") {
        // First dress (index 0) is larger, others are normal size
        scaleTarget = (index === 0) ? 1.6 : 1.0; // Increased first dress size
      }
      
      // Apply z offset after all adjustments
      object.position.z += zAdjustment;
      
      const maxDimension = Math.max(size.x, size.y, size.z);
      if (maxDimension > 0) {
        const s = (scaleTarget * 2.0) / maxDimension;
        object.scale.setScalar(s);
      }
      
      // Apply carousel slot positioning
      // Items are positioned on a circle around a pivot point
      // Their rotation naturally follows their position on the circle
      // When the carousel rotates, items smoothly move around the circle
      if (slot === 'prev') {
        // Left-back position on the carousel circle
        const angle = -CAROUSEL_ANGLE;
        // Position on circle relative to pivot point (carousel group origin)
        object.position.x = CAROUSEL_RADIUS * Math.sin(angle);
        object.position.z = CAROUSEL_RADIUS * Math.cos(angle);
        // Rotation matches the angle on the circle - naturally oriented based on position
        object.rotation.y = angle;
        object.scale.multiplyScalar(CAROUSEL_SCALE_SIDE);
      } else if (slot === 'next') {
        // Right-back position on the carousel circle
        const angle = CAROUSEL_ANGLE;
        object.position.x = CAROUSEL_RADIUS * Math.sin(angle);
        object.position.z = CAROUSEL_RADIUS * Math.cos(angle);
        // Rotation matches the angle on the circle - naturally oriented based on position
        object.rotation.y = angle;
        object.scale.multiplyScalar(CAROUSEL_SCALE_SIDE);
      } else if (slot === 'current') {
        // Current item is at the center of the carousel (angle 0)
        object.position.x = 0;
        // Preserve any z adjustments that were made (e.g., for shoes)
        // Add CAROUSEL_RADIUS to the current z position instead of overwriting it
        const currentZ = object.position.z;
        object.position.z = CAROUSEL_RADIUS + currentZ;
        // At center, facing forward
        object.rotation.y = 0;
      }
    }

    function loadModelToSlot(type, index, slot) {
      const total = assets[type].length;
      const normalizedIndex = (index + total) % total;
      const url = assets[type][normalizedIndex];
      
      return new Promise((resolve, reject) => {
      loader.load(
        url,
        (gltf) => {
            carouselSlots[type][slot].clear();
          gltf.scene.traverse((child) => { child.castShadow = true; });
            centerAndPlace(gltf.scene, type, slot, url, normalizedIndex);
            carouselSlots[type][slot].add(gltf.scene);
            resolve(gltf.scene);
        },
        undefined,
        (err) => {
          console.error(`Failed to load ${url}`, err);
            reject(err);
          }
        );
      });
    }
    
    function loadAllCarouselItems(type, showAll = false) {
      const total = assets[type].length;
      const currentIndex = current[type];
      
      // Only load current item - no prev/next
      const promises = [loadModelToSlot(type, currentIndex, 'current')];
      
      return Promise.all(promises).then(() => {
        // Always hide prev/next items - only show current
        carouselSlots[type].prev.visible = false;
        carouselSlots[type].next.visible = false;
        // Update rotations after loading
        updateItemRotations(type, carouselRotationState[type] || 0);
        // Toast removed
      }).catch((err) => {
          console.error("Failed to load asset. Check console.");
        return Promise.reject(err);
      });
    }
    
    // Legacy function for initial load (only show current during welcome)
    function loadModel(type, index) {
      current[type] = index;
      loadAllCarouselItems(type, false);
    }

    // Carousel rotation state
    const carouselRotationState = { shirts: 0, pants: 0, shoes: 0, dresses: 0 };
    const carouselAnimationState = { shirts: false, pants: false, shoes: false, dresses: false };
    const CAROUSEL_ROTATION_DURATION = 600; // milliseconds
    
    // Function to update item rotations as they move around the carousel
    // Simple approach: rotation directly matches the angle position on the circle
    // This creates a natural carousel effect where items rotate smoothly as they move
    function updateItemRotations(carouselType, carouselRotation) {
        // Calculate current angle positions of each slot as carousel rotates
        // As the carousel group rotates, items' positions on the circle change
        const prevAngle = -CAROUSEL_ANGLE + carouselRotation;
        const currentAngle = 0 + carouselRotation;
        const nextAngle = CAROUSEL_ANGLE + carouselRotation;
        
        // Rotation simply matches the angle position on the circle
        // This creates natural orientation as items move around the carousel
        function getRotationForAngle(angle) {
          // Normalize angle to [-œÄ, œÄ]
          let normalizedAngle = ((angle % (Math.PI * 2)) + Math.PI * 2) % (Math.PI * 2);
          if (normalizedAngle > Math.PI) normalizedAngle -= Math.PI * 2;
          return normalizedAngle;
        }
        
        // Update each slot's rotation to match its current position on the circle
        const prevSlot = carouselSlots[carouselType].prev;
        const currentSlot = carouselSlots[carouselType].current;
        const nextSlot = carouselSlots[carouselType].next;
        
        if (prevSlot.children.length > 0) {
          const scene = prevSlot.children[0];
          if (scene && scene.isObject3D) {
            scene.rotation.y = getRotationForAngle(prevAngle);
          }
        }
        
        if (currentSlot.children.length > 0) {
          const scene = currentSlot.children[0];
          if (scene && scene.isObject3D) {
            scene.rotation.y = getRotationForAngle(currentAngle);
          }
        }
        
        if (nextSlot.children.length > 0) {
          const scene = nextSlot.children[0];
          if (scene && scene.isObject3D) {
            scene.rotation.y = getRotationForAngle(nextAngle);
          }
        }
      }
    
    // Load a style combination
    function loadStyleCombination(styleIndex) {
      const style = styleCombinations[styleIndex];
      
      // Ensure indices are within bounds of original assets
      const shirtIndex = Math.min(Math.max(0, style.shirt), originalAssets.shirts.length - 1);
      const pantIndex = Math.min(Math.max(0, style.pant), originalAssets.pants.length - 1);
      const shoeIndex = Math.min(Math.max(0, style.shoe), originalAssets.shoes.length - 1);
      
      // For styles mode, always use original assets
      assets.shirts = [...originalAssets.shirts];
      assets.pants = [...originalAssets.pants];
      assets.shoes = [...originalAssets.shoes];
      
      // Set current indices
      current.shirts = shirtIndex;
      current.pants = pantIndex;
      current.shoes = shoeIndex;
      
      // Load all three items simultaneously
      const promises = [
        loadAllCarouselItems('shirts'),
        loadAllCarouselItems('pants'),
        loadAllCarouselItems('shoes')
      ];
      
      return Promise.all(promises);
    }
    
    // Switch between styles
    function switchStyle(dir) {
      const newIndex = (currentStyleIndex + dir + styleCombinations.length) % styleCombinations.length;
      currentStyleIndex = newIndex;
      
      loadStyleCombination(currentStyleIndex).catch(err => {
        console.error('Error loading style combination:', err);
      });
    }
    
    // Update arrow controls and mode button visibility based on current mode
    function updateModeUI() {
      const shirtsControls = document.querySelector('.arrow-controls.shirts');
      const pantsControls = document.querySelector('.arrow-controls.pants');
      const dressesControls = document.querySelector('.arrow-controls.dresses');
      const stylesControls = document.querySelector('.arrow-controls.styles');
      const modeButton = document.getElementById('mode-button');
      const backButton = document.getElementById('back-button');
      
      if (!shirtsControls || !pantsControls || !dressesControls || !modeButton || !backButton) return;
      
      // Show back button for all modes except initial welcome screen
      // This includes: browse, specific-menu, style, clothing-items
      if (navigationState === 'welcome') {
        // Initial welcome screen - hide back button
        backButton.classList.remove('visible');
      } else {
        // All other screens - show back button
        backButton.classList.add('visible');
      }
      
      if (currentMode === 'styles') {
        // Hide all individual controls (shirts, pants, shoes, dresses)
        shirtsControls.style.display = 'none';
        shirtsControls.classList.remove('visible');
        
        pantsControls.style.display = 'none';
        pantsControls.classList.remove('visible');
        // Restore pants controls data-type in case it was changed
        const pantsLeftBtn = pantsControls.querySelector('.arrow-btn.left');
        const pantsRightBtn = pantsControls.querySelector('.arrow-btn.right');
        if (pantsLeftBtn) pantsLeftBtn.setAttribute('data-type', 'pants');
        if (pantsRightBtn) pantsRightBtn.setAttribute('data-type', 'pants');
        
        const shoesControls = document.querySelector('.arrow-controls.shoes');
        if (shoesControls) {
          shoesControls.style.display = 'none';
          shoesControls.classList.remove('visible');
        }
        
        dressesControls.style.display = 'none';
        dressesControls.classList.remove('visible');
        
        // Show only the styles controls (middle arrow)
        if (stylesControls) {
          stylesControls.style.display = 'flex';
          stylesControls.classList.add('visible', 'show-after-click');
        }
        
        modeButton.style.display = 'none';
      } else if (currentMode === 'casual') {
        // Show shirts, pants, and shoes controls, hide dresses and styles
        shirtsControls.style.display = 'flex';
        shirtsControls.classList.add('visible');
        pantsControls.style.display = 'flex';
        pantsControls.classList.add('visible');
        // Restore pants controls data-type for casual mode
        const pantsLeftBtn = pantsControls.querySelector('.arrow-btn.left');
        const pantsRightBtn = pantsControls.querySelector('.arrow-btn.right');
        if (pantsLeftBtn) pantsLeftBtn.setAttribute('data-type', 'pants');
        if (pantsRightBtn) pantsRightBtn.setAttribute('data-type', 'pants');
        
        const shoesControls = document.querySelector('.arrow-controls.shoes');
        if (shoesControls) {
          shoesControls.style.display = 'flex';
          shoesControls.classList.add('visible');
        }
        dressesControls.style.display = 'none';
        dressesControls.classList.remove('visible');
        if (stylesControls) {
          stylesControls.style.display = 'none';
          stylesControls.classList.remove('visible');
        }
        modeButton.textContent = 'Dresses';
        modeButton.style.display = 'block';
      } else if (currentMode === 'dresses') {
        // Hide shirts and pants controls, show dresses with single arrow pair
        shirtsControls.style.display = 'none';
        shirtsControls.classList.remove('visible');
        pantsControls.style.display = 'none';
        pantsControls.classList.remove('visible');
        dressesControls.style.display = 'flex';
        dressesControls.classList.add('visible');
        if (stylesControls) {
          stylesControls.style.display = 'none';
          stylesControls.classList.remove('visible');
        }
        
        // Show both arrows for dresses (prev/next)
        const leftBtn = dressesControls.querySelector('.arrow-btn.left');
        const rightBtn = dressesControls.querySelector('.arrow-btn.right');
        if (leftBtn && rightBtn) {
          leftBtn.style.display = 'flex';
          rightBtn.style.display = 'flex';
        }
        
        modeButton.textContent = 'Casual';
        modeButton.style.display = 'block';
      }
    }

    function switchItem(type, dir) {
      // Handle styles mode separately
      if (type === 'styles') {
        switchStyle(dir);
        return;
      }
      
      if (carouselAnimationState[type]) return; // Don't allow switching during loading
      
      const total = assets[type].length;
      const newIndex = (current[type] + dir + total) % total;
      current[type] = newIndex;
      
      // Simply load the new item directly - no animation
      carouselAnimationState[type] = true;
      loadAllCarouselItems(type).then(() => {
        // Reset rotation state
        carouselRotationState[type] = 0;
        carouselGroups[type].rotation.y = 0;
        updateItemRotations(type, 0);
        carouselAnimationState[type] = false;
      });
    }
    
    // Mode switching function
    function switchMode() {
      if (currentMode === 'casual') {
        // Switch to dresses mode
        currentMode = 'dresses';
        
        // Hide shirts and pants
        if (groups.shirts) groups.shirts.visible = false;
        if (groups.pants) groups.pants.visible = false;
        if (groups.shoes) groups.shoes.visible = true; // Keep shoes visible
        
        // Show and load dresses
        if (groups.dresses) groups.dresses.visible = true;
        
        // Load first dress
        if (assets.dresses && assets.dresses.length > 0) {
          current.dresses = 0;
          carouselAnimationState['dresses'] = true;
          loadAllCarouselItems('dresses').then(() => {
            carouselRotationState['dresses'] = 0;
            carouselGroups['dresses'].rotation.y = 0;
            updateItemRotations('dresses', 0);
            carouselAnimationState['dresses'] = false;
          }).catch(err => {
            console.error('Error loading dresses:', err);
            carouselAnimationState['dresses'] = false;
          });
        }
      } else {
        // Switch to casual mode
        currentMode = 'casual';
        
        // Hide dresses
        if (groups.dresses) groups.dresses.visible = false;
        
        // Show shirts and pants
        if (groups.shirts) groups.shirts.visible = true;
        if (groups.pants) groups.pants.visible = true;
        if (groups.shoes) groups.shoes.visible = true;
        
        // Reload shirts and pants
        if (assets.shirts && assets.shirts.length > 0) {
          carouselAnimationState['shirts'] = true;
          loadAllCarouselItems('shirts').then(() => {
            carouselRotationState['shirts'] = 0;
            carouselGroups['shirts'].rotation.y = 0;
            updateItemRotations('shirts', 0);
            carouselAnimationState['shirts'] = false;
          }).catch(err => {
            console.error('Error loading shirts:', err);
            carouselAnimationState['shirts'] = false;
          });
        }
        if (assets.pants && assets.pants.length > 0) {
          carouselAnimationState['pants'] = true;
          loadAllCarouselItems('pants').then(() => {
            carouselRotationState['pants'] = 0;
            carouselGroups['pants'].rotation.y = 0;
            updateItemRotations('pants', 0);
            carouselAnimationState['pants'] = false;
          }).catch(err => {
            console.error('Error loading pants:', err);
            carouselAnimationState['pants'] = false;
          });
        }
      }
      
      // Update UI after a brief delay to ensure visibility changes
      setTimeout(() => {
        updateModeUI();
      }, 10);
    }

    // Event listeners for arrow buttons
    document.querySelectorAll(".arrow-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.type;
        const dir = Number(btn.dataset.dir);
        switchItem(type, dir);
      });
    });
    
    // Mode button event listener
    const modeButton = document.getElementById('mode-button');
    if (modeButton) {
      modeButton.addEventListener('click', () => {
        switchMode();
      });
    }
    
    // Unified function to animate model back to right side
    function animateModelBackToRight(onComplete, skipWelcomeOverlay = false, fasterAnimation = false) {
      if (isAnimating) return;
      
      isAnimating = true;
      
      // Make sure all groups are visible before resetting
      if (groups.shirts) groups.shirts.visible = true;
      if (groups.pants) groups.pants.visible = true;
      if (groups.shoes) groups.shoes.visible = true;
      
      // Reset clothing items to initial fit (first items)
      restoreOriginalAssets();
      ["shirts", "pants", "shoes"].forEach((type) => {
        if (assets[type] && assets[type].length > 0) {
          current[type] = 0;
          loadAllCarouselItems(type, false);
        }
      });
      
      // Hide all controls immediately
      document.querySelectorAll('.arrow-controls').forEach(ctrl => {
        ctrl.style.display = 'none';
        ctrl.classList.remove('visible');
      });
      if (modeButton) {
        modeButton.style.display = 'none';
        modeButton.classList.remove('visible');
      }
      
      // Show welcome overlay only if not skipping (for going back to filter screen)
      if (!skipWelcomeOverlay) {
        // Show welcome overlay first (for mobile where it uses display: none)
        welcomeOverlay.style.display = 'flex';
        // Force reflow to ensure display change is applied
        welcomeOverlay.offsetHeight;
        // Then remove slide-out class to animate back in
        welcomeOverlay.classList.remove('slide-out');
      } else {
        // Hide welcome overlay when going back to filter screen
        welcomeOverlay.style.display = 'none';
        welcomeOverlay.classList.add('slide-out');
      }
      
      // Start reverse animation - faster when going back to filter screen
      const reverseAnimationDuration = fasterAnimation ? animationDuration * 0.5 : animationDuration;
      animationStartTime = performance.now();
      
      // Capture starting position and rotation (current center position)
      const fromX = clothingGroup.position.x;
      const fromY = clothingGroup.position.y;
      const fromRotation = currentRotation % MAX_ROTATION;
      const normalizedFromRotation = fromRotation < 0 ? fromRotation + MAX_ROTATION : fromRotation;
      
      // Capture current camera position and controls target
      const fromCameraPos = new THREE.Vector3().copy(camera.position);
      const fromControlsTarget = new THREE.Vector3().copy(controls.target);
      
      // Target position and rotation (right side, rotation 0)
      const toX = isMobile ? leftCenterX : rightCenterX;
      const toY = isMobile ? leftCenterY : rightCenterY;
      const toRotation = 0;
      
      function animateReverse() {
        if (!isAnimating) return;
        
        const elapsed = performance.now() - animationStartTime;
        const progress = Math.min(elapsed / reverseAnimationDuration, 1);
        
        // Easing function (ease-out-cubic) - smoother easing
        const easeProgress = 1 - Math.pow(1 - progress, 3);
        
        // Smoothly translate from center back to initial position (right side)
        clothingGroup.position.x = fromX + (toX - fromX) * easeProgress;
        clothingGroup.position.y = fromY + (toY - fromY) * easeProgress;
        
        // Smoothly rotate back to initial rotation (0)
        currentRotation = normalizedFromRotation + (toRotation - normalizedFromRotation) * easeProgress;
        clothingGroup.rotation.y = currentRotation;
        
        // Smoothly animate camera position back to initial position
        camera.position.x = fromCameraPos.x + (initialCameraPosition.x - fromCameraPos.x) * easeProgress;
        camera.position.y = fromCameraPos.y + (initialCameraPosition.y - fromCameraPos.y) * easeProgress;
        camera.position.z = fromCameraPos.z + (initialCameraPosition.z - fromCameraPos.z) * easeProgress;
        
        // Smoothly animate controls target back to initial target
        controls.target.x = fromControlsTarget.x + (initialControlsTarget.x - fromControlsTarget.x) * easeProgress;
        controls.target.y = fromControlsTarget.y + (initialControlsTarget.y - fromControlsTarget.y) * easeProgress;
        controls.target.z = fromControlsTarget.z + (initialControlsTarget.z - fromControlsTarget.z) * easeProgress;
        controls.update();
        
        if (progress < 1) {
          requestAnimationFrame(animateReverse);
        } else {
          // Animation complete - reset to starting position and rotation
          clothingGroup.position.x = toX;
          clothingGroup.position.y = toY;
          clothingGroup.rotation.y = toRotation;
          currentRotation = toRotation;
          
          // Reset camera and controls to initial state
          camera.position.copy(initialCameraPosition);
          controls.target.copy(initialControlsTarget);
          controls.update();
          
          isAnimating = false;
          isRotating = true; // Continue rotation in place after animation
          
          // Call completion callback if provided
          if (onComplete) onComplete();
        }
      }
      
      requestAnimationFrame(animateReverse);
    }
    
    // Helper function to setup welcome buttons based on target state
    function setupWelcomeButtons(targetState) {
      const welcomeButtons = document.getElementById('welcome-buttons');
      if (!welcomeButtons) return;
      
      if (targetState === 'welcome') {
        // Initial welcome screen - Free Browse and Specific buttons
        welcomeButtons.innerHTML = `
          <button class="welcome-button" id="free-browse-button">Free Browse</button>
          <button class="welcome-button" id="specific-button">Specific</button>
        `;
        welcomeButtons.classList.add('two-buttons');
        
        const freeBtn = document.getElementById('free-browse-button');
        const specBtn = document.getElementById('specific-button');
        
        if (freeBtn) {
          freeBtn.addEventListener('click', () => {
            randomizeAssets();
            navigationState = 'browse';
            currentMode = 'casual';
            isAnimating = false;
            startAnimation();
          });
        }
        
        if (specBtn) {
          specBtn.addEventListener('click', () => {
            navigationState = 'specific-menu';
            setupWelcomeButtons('specific-menu');
            const backBtn = document.getElementById('back-button');
            if (backBtn) backBtn.classList.add('visible');
          });
        }
      } else if (targetState === 'specific-menu') {
        // Specific menu - Style and Clothing Items buttons
        welcomeButtons.innerHTML = '';
        welcomeButtons.classList.remove('two-buttons');
        welcomeButtons.style.gap = '16px';
        
        const styleBtn = document.createElement("button");
        styleBtn.className = "welcome-button";
        styleBtn.id = "style-button";
        styleBtn.textContent = "Style";
        
        const clothingBtn = document.createElement("button");
        clothingBtn.className = "welcome-button";
        clothingBtn.id = "clothing-items-button";
        clothingBtn.textContent = "Clothing Items";
        
        welcomeButtons.appendChild(styleBtn);
        welcomeButtons.appendChild(clothingBtn);
        
        styleBtn.addEventListener("click", () => {
          restoreOriginalAssets();
          navigationState = 'style';
          currentMode = 'styles';
          currentStyleIndex = 0;
          // Update UI immediately to hide all arrow controls except styles
          updateModeUI();
          isAnimating = false;
          startAnimation();
        });
        
        clothingBtn.addEventListener("click", () => {
          restoreOriginalAssets();
          // Show filter screen first instead of animating immediately
          navigationState = 'clothing-items-filter';
          showFilterOverlay();
          const backBtn = document.getElementById('back-button');
          if (backBtn) backBtn.classList.add('visible');
        });
      }
    }
    
    // Reverse animation function (animate avatar back to starting position)
    function reverseAnimation() {
      // animateModelBackToRight now handles clothing reset internally
      animateModelBackToRight(() => {
        if (backButton) backButton.classList.remove('visible');
        setupWelcomeButtons('welcome');
      });
    }
    
    
    // Back button handler - navigates back to previous page in hierarchy
    const backButton = document.getElementById('back-button');
    if (backButton) {
      backButton.addEventListener('click', () => {
        if (navigationState === 'browse') {
          // Free Browse mode ‚Üí go back to initial page
          // If currently in dresses mode, switch back to casual mode first
          if (currentMode === 'dresses') {
            // Switch from dresses to casual mode
            currentMode = 'casual';
            // Hide dresses
            if (groups.dresses) groups.dresses.visible = false;
            // Show shirts and pants
            if (groups.shirts) groups.shirts.visible = true;
            if (groups.pants) groups.pants.visible = true;
            if (groups.shoes) groups.shoes.visible = true;
            // Update UI to reflect casual mode
            updateModeUI();
          }
          navigationState = 'welcome';
          currentMode = 'casual';
          reverseAnimation();
        } else if (navigationState === 'clothing-items-filter') {
          // Filter screen ‚Üí go back to Style/Clothing Items menu (no animation)
          navigationState = 'specific-menu';
          // Clear filter selections (both current and last applied)
          selectedFilters = { tops: [], bottoms: [], shoes: [] };
          lastAppliedFilters = { tops: [], bottoms: [], shoes: [] };
          // Restore original assets to clear any applied filters
          restoreOriginalAssets();
          // Make sure all groups are visible again (in case they were hidden by filters)
          if (groups.shirts) groups.shirts.visible = true;
          if (groups.pants) groups.pants.visible = true;
          if (groups.shoes) groups.shoes.visible = true;
          // Hide filter overlay and show welcome overlay with Style/Clothing Items buttons
          hideFilterOverlay();
          const welcomeOverlay = document.getElementById('welcome-overlay');
          if (welcomeOverlay) {
            welcomeOverlay.style.display = 'flex';
            welcomeOverlay.classList.remove('slide-out');
          }
          setupWelcomeButtons('specific-menu');
          // Back button stays visible at specific-menu
        } else if (navigationState === 'style' || navigationState === 'clothing-items') {
          // Style or Clothing Items mode ‚Üí go back
          // If currently in dresses mode, switch back to casual mode first
          if (currentMode === 'dresses') {
            // Switch from dresses to casual mode
            currentMode = 'casual';
            // Hide dresses
            if (groups.dresses) groups.dresses.visible = false;
            // Show shirts and pants
            if (groups.shirts) groups.shirts.visible = true;
            if (groups.pants) groups.pants.visible = true;
            if (groups.shoes) groups.shoes.visible = true;
            // Update UI to reflect casual mode
            updateModeUI();
          }
          
          // For clothing-items, go back to filter screen with remembered selections
          if (navigationState === 'clothing-items') {
            navigationState = 'clothing-items-filter';
            // Make sure all groups are visible again before animating back
            if (groups.shirts) groups.shirts.visible = true;
            if (groups.pants) groups.pants.visible = true;
            if (groups.shoes) groups.shoes.visible = true;
            
            // On mobile/iPad, show filter immediately without animation
            if (isMobile || window.innerWidth <= 1024) {
              // Reset clothing items to initial fit (first items)
              restoreOriginalAssets();
              ["shirts", "pants", "shoes"].forEach((type) => {
                if (assets[type] && assets[type].length > 0) {
                  current[type] = 0;
                  loadAllCarouselItems(type, false);
                }
              });
              
              // Hide all controls
              document.querySelectorAll('.arrow-controls').forEach(ctrl => {
                ctrl.style.display = 'none';
                ctrl.classList.remove('visible');
              });
              const modeButton = document.getElementById('mode-button');
              if (modeButton) {
                modeButton.style.display = 'none';
                modeButton.classList.remove('visible');
              }
              
              // Reset model position immediately (no animation on mobile/iPad)
              clothingGroup.position.x = isMobile ? leftCenterX : rightCenterX;
              clothingGroup.position.y = isMobile ? leftCenterY : rightCenterY;
              clothingGroup.rotation.y = 0;
              currentRotation = 0;
              camera.position.copy(initialCameraPosition);
              controls.target.copy(initialControlsTarget);
              controls.update();
              
              // Show filter overlay immediately
              const filterOverlay = document.getElementById('filter-overlay');
              const welcomeOverlay = document.getElementById('welcome-overlay');
              if (filterOverlay) {
                if (welcomeOverlay) {
                  welcomeOverlay.style.display = 'none';
                  welcomeOverlay.classList.add('slide-out');
                }
                filterOverlay.classList.add('visible');
                // Initialize UI first (set up handlers), then restore selections
                initializeFilterUI(false);
                restoreFilterSelections();
              }
            } else {
              // On desktop, animate model back to right and reset clothing, then show filter screen
              // Don't show welcome overlay - go straight to filter screen
              // Use faster animation for better UX when going back to filters
              animateModelBackToRight(() => {
                // Show filter overlay with remembered selections after animation
                const filterOverlay = document.getElementById('filter-overlay');
                const welcomeOverlay = document.getElementById('welcome-overlay');
                if (filterOverlay) {
                  // Hide welcome overlay if it's visible
                  if (welcomeOverlay) {
                    welcomeOverlay.style.display = 'none';
                    welcomeOverlay.classList.add('slide-out');
                  }
                  filterOverlay.classList.add('visible');
                  // Initialize UI first (set up handlers), then restore selections
                  initializeFilterUI(false);
                  restoreFilterSelections();
                }
              }, true, true); // Pass true to skip welcome overlay, true for faster animation
            }
          } else {
            // For style mode, go back to specific-menu
            navigationState = 'specific-menu';
            animateModelBackToRight(() => {
              setupWelcomeButtons('specific-menu');
              // Back button stays visible at specific-menu
            });
          }
        } else if (navigationState === 'specific-menu') {
          // Style/Clothing Items menu ‚Üí go back to initial page
          // Just change the welcome screen buttons, don't animate the model
          navigationState = 'welcome';
          setupWelcomeButtons('welcome');
          if (backButton) backButton.classList.remove('visible');
        }
      });
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
    window.addEventListener("resize", onResize);

    // Welcome overlay setup
    const welcomeOverlay = document.getElementById("welcome-overlay");
    
    let isAnimating = false;
    const animationDuration = 1200; // milliseconds
    let animationStartTime = null;
    let initialRotationValue = 0; // will be set when button is clicked
    
    function startAnimation() {
      if (isAnimating) return;
      
      isAnimating = true;
      isRotating = false; // Stop the rotation
      welcomeOverlay.classList.add("slide-out");
      
      // Capture the current rotation as the initial value (normalized to 0-2œÄ)
      initialRotationValue = currentRotation % MAX_ROTATION;
      if (initialRotationValue < 0) initialRotationValue += MAX_ROTATION;
      
      // Start the clothing animation
      animationStartTime = performance.now();
      
      function animateClothing() {
        if (!isAnimating) return;
        
        const elapsed = performance.now() - animationStartTime;
        const progress = Math.min(elapsed / animationDuration, 1);
        
        // Easing function (ease-out-cubic)
        const easeProgress = 1 - Math.pow(1 - progress, 3);
        
        // Smoothly rotate back to 0 (initial position) while translating to center
        const targetRotation = 0;
        currentRotation = initialRotationValue + (targetRotation - initialRotationValue) * easeProgress;
        clothingGroup.rotation.y = currentRotation;
        
        // Smoothly translate from initial position to center (horizontally and vertically)
        const startX = isMobile ? leftCenterX : rightCenterX;
        const startY = isMobile ? leftCenterY : rightCenterY;
        const targetX = targetCenterX;
        clothingGroup.position.x = startX + (targetX - startX) * easeProgress;
        
        // Smoothly translate from lower position to target height
        const targetY = targetCenterY;
        clothingGroup.position.y = startY + (targetY - startY) * easeProgress;
        
        // Camera target stays at center (already at 0), no need to animate it
        
        if (progress < 1) {
          requestAnimationFrame(animateClothing);
        } else {
          // Animation complete
          clothingGroup.position.x = targetCenterX;
          clothingGroup.position.y = targetCenterY;
          clothingGroup.rotation.y = 0;
          currentRotation = 0;
          isAnimating = false;
          
          // Reload all items based on mode
          if (currentMode === 'styles') {
            loadStyleCombination(currentStyleIndex).catch(err => {
              console.error('Error loading style combination:', err);
            });
          } else {
            ["shirts", "pants", "shoes"].forEach((type) => {
              if (assets[type] && assets[type].length > 0) {
                loadAllCarouselItems(type, false);
              }
            });
          }
          // Initialize mode UI (this will handle showing arrows based on mode)
          updateModeUI();
          
          // Show arrow controls and mode button when items reach center (after updateModeUI)
          document.querySelectorAll(".arrow-controls.visible").forEach(ctrl => {
            ctrl.classList.add("visible", "show-after-click");
          });
          const modeButton = document.getElementById('mode-button');
          if (modeButton) modeButton.classList.add('visible');
        }
      }
      
      requestAnimationFrame(animateClothing);
    }
    
    // Welcome screen button handlers
    const freeBrowseButton = document.getElementById("free-browse-button");
    const specificButton = document.getElementById("specific-button");
    const welcomeButtons = document.getElementById("welcome-buttons");
    
    // Helper function to shuffle array (Fisher-Yates algorithm)
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }
    
    // Function to randomize asset order (keep first item, shuffle the rest)
    function randomizeAssets() {
      // Keep first item, shuffle the rest
      function shuffleFromSecond(array) {
        if (array.length <= 1) return [...array];
        const first = array[0];
        const rest = shuffleArray([...array.slice(1)]);
        return [first, ...rest];
      }
      
      assets.shirts = shuffleFromSecond(originalAssets.shirts);
      assets.pants = shuffleFromSecond(originalAssets.pants);
      assets.shoes = shuffleFromSecond(originalAssets.shoes);
      
      // Reset current indices to start from the beginning
      current.shirts = 0;
      current.pants = 0;
      current.shoes = 0;
      
      console.log("Assets randomized for free browse mode (first item preserved)");
    }
    
    // Function to restore original asset order
    function restoreOriginalAssets() {
      assets.shirts = [...originalAssets.shirts];
      assets.pants = [...originalAssets.pants];
      assets.shoes = [...originalAssets.shoes];
      
      current.shirts = 0;
      current.pants = 0;
      current.shoes = 0;
    }
    
    // Filter assets based on selected filters
    function applyFilters() {
      restoreOriginalAssets();
      
      // Filter shirts based on tops selection
      if (selectedFilters.tops.length > 0) {
        assets.shirts = originalAssets.shirts.filter(url => {
          const filename = url.split('/').pop().toLowerCase();
          return selectedFilters.tops.some(filter => filename.includes(filter));
        });
      } else {
        // If no filters selected for tops, show no items
        assets.shirts = [];
      }
      
      // Filter pants based on bottoms selection (including shorts)
      if (selectedFilters.bottoms.length > 0) {
        // Get all bottoms items (pants + shorts from manifest)
        const allBottoms = [...originalAssets.pants];
        if (manifest.shorts) {
          manifest.shorts.forEach(file => {
            allBottoms.push(u(`shorts/${file}`));
          });
        }
        
        assets.pants = allBottoms.filter(url => {
          const filename = url.split('/').pop().toLowerCase();
          return selectedFilters.bottoms.some(filter => {
            if (filter === 'pants') {
              // Match pants but not shorts, skirts, jeans, leggings
              return filename.includes('pant') && 
                     !filename.includes('short') && 
                     !filename.includes('skirt') && 
                     !filename.includes('jean') && 
                     !filename.includes('legging');
            }
            if (filter === 'shorts') {
              return filename.includes('short');
            }
            if (filter === 'skirts') {
              return filename.includes('skirt');
            }
            if (filter === 'jeans') {
              return filename.includes('jean');
            }
            if (filter === 'leggings') {
              return filename.includes('legging');
            }
            return filename.includes(filter);
          });
        });
      } else {
        // If no filters selected for bottoms, show no items
        assets.pants = [];
      }
      
      // Filter shoes based on shoes selection
      if (selectedFilters.shoes.length > 0) {
        assets.shoes = originalAssets.shoes.filter(url => {
          const filename = url.split('/').pop().toLowerCase();
          if (selectedFilters.shoes.includes('other')) {
            // For "other", include items that don't match basketball, tennis, or dress
            const isBasketball = filename.includes('basketball');
            const isTennis = filename.includes('tennis');
            const isDress = filename.includes('dress');
            if (isBasketball || isTennis || isDress) return false;
            return true;
          }
          return selectedFilters.shoes.some(filter => {
            if (filter === 'basketball') return filename.includes('basketball');
            if (filter === 'tennis') return filename.includes('tennis');
            if (filter === 'dress') return filename.includes('dress');
            return false;
          });
        });
      } else {
        // If no filters selected for shoes, show no items
        assets.shoes = [];
      }
      
      // Reset current indices
      current.shirts = 0;
      current.pants = 0;
      current.shoes = 0;
      
      // Hide groups for categories with no items (empty filters) and clear their slots
      if (assets.shirts.length === 0) {
        if (groups.shirts) groups.shirts.visible = false;
        // Clear the carousel slots for shirts
        carouselSlots.shirts.prev.clear();
        carouselSlots.shirts.current.clear();
        carouselSlots.shirts.next.clear();
      } else {
        if (groups.shirts) groups.shirts.visible = true;
      }
      
      if (assets.pants.length === 0) {
        if (groups.pants) groups.pants.visible = false;
        // Clear the carousel slots for pants
        carouselSlots.pants.prev.clear();
        carouselSlots.pants.current.clear();
        carouselSlots.pants.next.clear();
      } else {
        if (groups.pants) groups.pants.visible = true;
      }
      
      if (assets.shoes.length === 0) {
        if (groups.shoes) groups.shoes.visible = false;
        // Clear the carousel slots for shoes
        carouselSlots.shoes.prev.clear();
        carouselSlots.shoes.current.clear();
        carouselSlots.shoes.next.clear();
      } else {
        if (groups.shoes) groups.shoes.visible = true;
      }
    }
    
    // Store filter option click handlers to avoid duplicates
    let filterOptionHandlers = new Map();
    
    // Initialize filter UI
    function initializeFilterUI(resetFilters = false) {
      const filterOverlay = document.getElementById('filter-overlay');
      const filterOptions = document.querySelectorAll('.filter-option');
      const applyButton = document.getElementById('apply-filters-button');
      
      // Only reset filter selections if explicitly requested (not when restoring)
      if (resetFilters) {
        selectedFilters = { tops: [], bottoms: [], shoes: [] };
      }
      
      // Clear all selected states
      filterOptions.forEach(option => {
        option.classList.remove('selected');
        // Remove old listener if it exists
        if (filterOptionHandlers.has(option)) {
          option.removeEventListener('click', filterOptionHandlers.get(option));
        }
      });
      
      // Add click handlers to filter options (only once)
      filterOptions.forEach(option => {
        const handler = () => {
          const filterValue = option.dataset.filter;
          const category = option.closest('.filter-category').querySelector('h3').textContent.toLowerCase();
          
          // Determine which filter array to use
          let filterArray;
          if (category === 'tops') {
            filterArray = selectedFilters.tops;
          } else if (category === 'bottoms') {
            filterArray = selectedFilters.bottoms;
          } else if (category === 'shoes') {
            filterArray = selectedFilters.shoes;
          } else {
            return;
          }
          
          // Toggle selection
          if (option.classList.contains('selected')) {
            option.classList.remove('selected');
            const index = filterArray.indexOf(filterValue);
            if (index > -1) filterArray.splice(index, 1);
          } else {
            option.classList.add('selected');
            filterArray.push(filterValue);
          }
        };
        
        option.addEventListener('click', handler);
        filterOptionHandlers.set(option, handler);
      });
      
      // Remove old apply button listener if it exists
      if (applyButton && applyButton._applyHandler) {
        applyButton.removeEventListener('click', applyButton._applyHandler);
      }
      
      // Apply filters button handler
      const applyHandler = () => {
        // Store current filter selections before applying
        lastAppliedFilters = {
          tops: [...selectedFilters.tops],
          bottoms: [...selectedFilters.bottoms],
          shoes: [...selectedFilters.shoes]
        };
        
        // Apply filters
        applyFilters();
        
        // Hide filter overlay
        filterOverlay.classList.remove('visible');
        
        // Navigate to clothing items view with animation
        navigationState = 'clothing-items';
        currentMode = 'casual';
        isAnimating = false;
        startAnimation();
      };
      
      if (applyButton) {
        applyButton._applyHandler = applyHandler;
        applyButton.addEventListener('click', applyHandler);
      }
    }
    
    // Restore filter selections from last applied filters
    function restoreFilterSelections() {
      selectedFilters = {
        tops: [...lastAppliedFilters.tops],
        bottoms: [...lastAppliedFilters.bottoms],
        shoes: [...lastAppliedFilters.shoes]
      };
      
      // Update UI to show selected filters
      document.querySelectorAll('.filter-option').forEach(option => {
        option.classList.remove('selected');
        const filterValue = option.dataset.filter;
        const category = option.closest('.filter-category').querySelector('h3').textContent.toLowerCase();
        
        let filterArray;
        if (category === 'tops') {
          filterArray = selectedFilters.tops;
        } else if (category === 'bottoms') {
          filterArray = selectedFilters.bottoms;
        } else if (category === 'shoes') {
          filterArray = selectedFilters.shoes;
        } else {
          return;
        }
        
        if (filterArray.includes(filterValue)) {
          option.classList.add('selected');
        }
      });
    }
    
    // Show filter overlay
    function showFilterOverlay() {
      const filterOverlay = document.getElementById('filter-overlay');
      const welcomeOverlay = document.getElementById('welcome-overlay');
      if (filterOverlay) {
        // Hide welcome overlay if visible
        if (welcomeOverlay) {
          welcomeOverlay.style.display = 'none';
          welcomeOverlay.classList.add('slide-out');
        }
        filterOverlay.classList.add('visible');
        // Reset filters and initialize UI (fresh start from menu)
        selectedFilters = { tops: [], bottoms: [], shoes: [] };
        lastAppliedFilters = { tops: [], bottoms: [], shoes: [] };
        initializeFilterUI(true);
      }
    }
    
    // Hide filter overlay
    function hideFilterOverlay() {
      const filterOverlay = document.getElementById('filter-overlay');
      if (filterOverlay) {
        filterOverlay.classList.remove('visible');
      }
    }
    
    // Free Browse button handler
    freeBrowseButton.addEventListener("click", () => {
      randomizeAssets();
      navigationState = 'browse';
      currentMode = 'casual';
      startAnimation();
    });
    
    // Specific button handler - show Style and Clothing Items buttons
    specificButton.addEventListener("click", () => {
      navigationState = 'specific-menu';
      setupWelcomeButtons('specific-menu');
      const backBtn = document.getElementById('back-button');
      if (backBtn) backBtn.classList.add('visible');
    });
    
    // Legacy go button handler (kept for compatibility - check if exists)
    const legacyGoButton = document.getElementById("go-button");
    if (legacyGoButton) {
      legacyGoButton.addEventListener("click", startAnimation);
    }

    // Initialize: load initial models
    // Verify we have assets before loading
    const hasAssets = Object.values(assets).some(arr => arr.length > 0);
    if (hasAssets) {
      // Both mobile and desktop: show welcome screen, load initial models
      // On mobile, welcome screen is full screen
      // On desktop, it's half screen
      ["shirts", "pants", "shoes"].forEach((type) => {
        if (assets[type] && assets[type].length > 0) {
          loadModel(type, 0);
        }
      });
      // Initialize mode UI
      updateModeUI();
    } else {
      console.error("No assets found in manifest.");
    }

    function animate() {
      requestAnimationFrame(animate);
      
      // Rotate clothing in place at the start (continuous rotation around initial offset)
      if (isRotating) {
        currentRotation += rotationSpeed;
        clothingGroup.rotation.y = currentRotation;
      }
      
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>

