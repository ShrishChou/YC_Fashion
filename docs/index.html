<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mirim</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(120% 120% at 50% 0%, #1e2433 0%, #0c0e16 55%, #07080f 100%);
      color: #e6e9f2;
      overflow: hidden;
    }
    #app {
      position: fixed;
      inset: 0;
    }
    #canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    #topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: rgba(9, 11, 18, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      z-index: 250;
      box-sizing: border-box;
    }
    .topbar-left {
      flex: 0 0 auto;
    }
    .wordmark {
      font-size: 20px;
      font-weight: 400;
      letter-spacing: 2px;
      color: #e6e9f2;
      text-transform: lowercase;
    }
    .topbar-center {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 32px;
    }
    .nav-link {
      font-size: 14px;
      font-weight: 400;
      color: rgba(230, 233, 242, 0.7);
      text-decoration: none;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: color 0.2s ease;
      cursor: pointer;
    }
    .nav-link:hover {
      color: rgba(230, 233, 242, 1);
    }
    .topbar-right {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .nav-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #e6e9f2;
      padding: 8px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
    }
    .demo-text-short {
      display: none;
    }
    .nav-button:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }
    #status-pill {
      position: absolute;
      top: 72px;
      right: 32px;
      background: rgba(9, 11, 18, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: rgba(230, 233, 242, 0.9);
      z-index: 251;
      transition: opacity 0.3s ease;
    }
    #status-pill.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .status-text {
      font-weight: 500;
    }
    .status-retry {
      background: rgba(63, 94, 251, 0.2);
      border: 1px solid rgba(106, 133, 255, 0.3);
      color: #6a85ff;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .status-retry:hover {
      background: rgba(63, 94, 251, 0.3);
      border-color: rgba(106, 133, 255, 0.5);
    }
    .status-retry.hidden {
      display: none;
    }
    /* Boutique loading spinner */
    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(106, 133, 255, 0.2);
      border-top-color: rgba(106, 133, 255, 0.8);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #status-pill:not(.loading) .loading-spinner {
      display: none;
    }
    @media (max-width: 768px) {
      #topbar {
        padding: 0 20px;
        height: 56px;
      }
      .topbar-center {
        gap: 16px;
      }
      .nav-link {
        font-size: 12px;
      }
      .nav-button {
        padding: 6px 16px;
        font-size: 12px;
      }
      #status-pill {
        top: 64px;
        right: 20px;
        font-size: 12px;
        padding: 6px 12px;
      }
    }
    @media (max-width: 480px) {
      #topbar {
        padding: 0 12px;
      }
      .wordmark {
        font-size: 16px;
        letter-spacing: 1px;
      }
      .topbar-center {
        gap: 10px;
      }
      .nav-link {
        font-size: 10px;
        letter-spacing: 0.3px;
      }
      .nav-button {
        padding: 6px 12px;
        font-size: 11px;
      }
      .demo-text-full {
        display: none;
      }
      .demo-text-short {
        display: inline;
      }
    }
    #demo-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 300;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.3s ease, visibility 0.3s;
    }
    #demo-modal.visible {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .demo-modal-content {
      position: relative;
      background: rgba(9, 11, 18, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 40px;
      max-width: 480px;
      width: 90%;
      box-sizing: border-box;
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #demo-modal.visible .demo-modal-content {
      transform: scale(1);
    }
    .demo-modal-header {
      margin-bottom: 24px;
    }
    .demo-modal-header h2 {
      font-size: 28px;
      font-weight: 300;
      letter-spacing: -0.5px;
      color: #e6e9f2;
      margin: 0 0 8px 0;
    }
    .demo-modal-header p {
      font-size: 15px;
      color: rgba(230, 233, 242, 0.6);
      margin: 0;
    }
    .demo-modal-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .demo-modal-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 14px 18px;
      color: #e6e9f2;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
      box-sizing: border-box;
      width: 100%;
    }
    .demo-modal-input:focus {
      outline: none;
      border-color: rgba(106, 133, 255, 0.4);
      background: rgba(255, 255, 255, 0.08);
    }
    .demo-modal-input::placeholder {
      color: rgba(230, 233, 242, 0.4);
    }
    .demo-modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    .demo-modal-button {
      flex: 1;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: inherit;
    }
    .demo-modal-button.cancel {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(230, 233, 242, 0.8);
    }
    .demo-modal-button.cancel:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
    }
    .demo-modal-button.send {
      background: linear-gradient(135deg, #3f5efb 0%, #6a85ff 100%);
      color: #fff;
      box-shadow: 0 4px 15px rgba(82, 114, 255, 0.3);
    }
    .demo-modal-button.send:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(82, 114, 255, 0.4);
    }
    .demo-modal-button.send:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    #demo-form-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .demo-success-message {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }
    .demo-success-message p {
      font-size: 16px;
      color: rgba(230, 233, 242, 0.9);
      margin: 0;
    }
    .demo-success-message.hidden {
      display: none;
    }
    #demo-form-content.hidden {
      display: none;
    }
    .demo-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: rgba(230, 233, 242, 0.6);
      font-size: 24px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
      line-height: 1;
      padding: 0;
    }
    .demo-modal-close:hover {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(230, 233, 242, 0.9);
    }
    @media (max-width: 768px) {
      .demo-modal-content {
        padding: 32px 24px;
      }
      .demo-modal-header h2 {
        font-size: 24px;
      }
    }
    #hud {
      position: absolute;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      padding: 12px 16px;
      background: rgba(9, 11, 18, 0.72);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }
    #hud.visible {
      opacity: 1;
      pointer-events: auto;
    }
    #intro-overlay {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(9, 11, 18, 0.98);
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px;
      box-sizing: border-box;
      z-index: 200;
      transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.8s;
    }
    #intro-overlay.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    /* Mobile styles - full screen layout */
    @media (max-width: 768px) {
      #intro-overlay {
        padding: 20px;
      }
      /* Mobile: position arrows at screen edges */
      .arrow-controls {
        width: 100%;
      }
      .arrow-btn.left {
        left: 10px !important;
        right: auto !important;
      }
      .arrow-btn.right {
        right: 10px !important;
        left: auto !important;
      }
      /* Keep individual clothing type vertical positions */
      .arrow-controls.shirts {
        top: 25%;
      }
      .arrow-controls.pants {
        top: 45%;
      }
      .arrow-controls.shoes {
        top: 65%;
      }
      .arrow-controls.dresses {
        top: 35%;
      }
    }
    /* iPad portrait - full screen layout (like mobile) */
    @media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
      /* iPad portrait: position arrows at screen edges */
      .arrow-controls {
        width: 100%;
      }
      .arrow-btn.left {
        left: 10px !important;
        right: auto !important;
      }
      .arrow-btn.right {
        right: 10px !important;
        left: auto !important;
      }
      /* Keep individual clothing type vertical positions */
      .arrow-controls.shirts {
        top: 25%;
      }
      .arrow-controls.pants {
        top: 45%;
      }
      .arrow-controls.shoes {
        top: 65%;
      }
      .arrow-controls.dresses {
        top: 35%;
      }
    }
    #intro-content {
      text-align: center;
      max-width: 600px;
    }
    #intro-content h1 {
      font-size: 64px;
      font-weight: 300;
      letter-spacing: -1px;
      margin: 0 0 24px 0;
      color: #e6e9f2;
      line-height: 1.2;
    }
    #intro-content .subhead {
      font-size: 22px;
      font-weight: 400;
      color: rgba(230, 233, 242, 0.75);
      margin: 0 0 16px 0;
      line-height: 1.6;
    }
    #intro-content .credibility {
      font-size: 14px;
      font-weight: 400;
      color: rgba(230, 233, 242, 0.5);
      margin: 0 0 48px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #intro-content .beta-tag {
      font-size: 11px;
      font-weight: 500;
      color: rgba(230, 233, 242, 0.4);
      margin: 0 0 56px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #intro-start-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #e6e9f2;
      padding: 18px 56px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
    }
    #intro-start-button:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    #intro-start-button:active {
      transform: translateY(0);
    }
    #welcome-buttons {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
    }
    #welcome-buttons.two-buttons {
      flex-direction: row;
      gap: 20px;
      max-width: 400px;
    }
    .welcome-button {
      background: linear-gradient(135deg, #3f5efb 0%, #6a85ff 100%);
      border: none;
      color: #fff;
      padding: 16px 48px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
      box-shadow: 0 10px 30px rgba(82, 114, 255, 0.4);
      width: 100%;
    }
    .welcome-button.hidden {
      opacity: 0;
      pointer-events: none;
      width: 0;
      padding: 16px 0;
      margin: 0;
    }
    .welcome-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(82, 114, 255, 0.5);
    }
    .welcome-button:active {
      transform: translateY(0);
    }
    .arrow-controls {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }
    .arrow-controls.visible {
      opacity: 1;
      pointer-events: auto;
    }
    /* On desktop, hide arrows initially until button is clicked, except dresses */
    @media (min-width: 769px) {
      .arrow-controls:not(.show-after-click):not(.dresses) {
        opacity: 0 !important;
        pointer-events: none !important;
      }
      .arrow-controls.show-after-click.visible {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      /* Dresses arrows always visible on desktop */
      .arrow-controls.dresses.visible {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
    }
    .arrow-btn {
      position: absolute;
      width: 56px;
      height: 56px;
      background: none;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0;
    }
    .arrow-btn:hover {
      transform: scale(1.2);
    }
    .arrow-btn:active {
      transform: scale(1.1);
      transition: all 0.1s ease;
    }
    /* Modern chevron arrows using CSS - grey sleek color */
    .arrow-btn.left::before,
    .arrow-btn.right::before {
      content: '';
      display: block;
      width: 18px;
      height: 18px;
      border-top: 3px solid rgba(180, 180, 180, 0.85);
      border-right: 3px solid rgba(180, 180, 180, 0.85);
      margin: auto;
      transition: all 0.3s ease;
    }
    .arrow-btn.left::before {
      transform: rotate(-135deg);
    }
    .arrow-btn.right::before {
      transform: rotate(45deg);
    }
    .arrow-btn:hover::before {
      border-color: rgba(220, 220, 220, 1);
      border-width: 3.5px;
    }
    .arrow-btn.left:hover::before {
      transform: rotate(-135deg) translateX(-3px);
    }
    .arrow-btn.right:hover::before {
      transform: rotate(45deg) translateX(3px);
    }
    /* Desktop: position arrows with consistent spacing from center (responsive to viewport) */
    .arrow-btn.left {
      left: calc(50% - 180px);
    }
    .arrow-btn.right {
      right: calc(50% - 180px);
    }
    /* iPad landscape: wider spacing for better usability */
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
      .arrow-btn.left {
        left: calc(50% - 220px);
      }
      .arrow-btn.right {
        right: calc(50% - 220px);
      }
    }
    /* Medium screens (770-900px): wider spacing to prevent arrows being too close */
    @media (min-width: 770px) and (max-width: 900px) {
      .arrow-btn.left {
        left: calc(50% - 160px);
      }
      .arrow-btn.right {
        right: calc(50% - 160px);
      }
    }
    /* Tablet: slightly closer spacing */
    @media (max-width: 769px) {
      .arrow-btn.left {
        left: calc(50% - 100px);
      }
      .arrow-btn.right {
        right: calc(50% - 100px);
      }
    }
    /* Mobile: position arrows at screen edges */
    @media (max-width: 768px) {
      .arrow-btn.left {
        left: 10px !important;
        right: auto !important;
      }
      .arrow-btn.right {
        right: 10px !important;
        left: auto !important;
      }
    }
    .arrow-btn.single {
      left: 50%;
      transform: translateX(-50%);
    }
    /* Position arrow controls for each clothing type - closer to center where clothes are */
    .arrow-controls.shirts {
      top: 25%;
      left: 0;
      right: 0;
    }
    .arrow-controls.pants {
      top: 45%;
      left: 0;
      right: 0;
    }
    .arrow-controls.shoes {
      top: 65%;
      left: 0;
      right: 0;
    }
    .arrow-controls.dresses {
      top: 35%;
      left: 0;
      right: 0;
    }
    #mode-button {
      position: absolute;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: linear-gradient(135deg, #3f5efb 0%, #6a85ff 100%);
      border: none;
      color: #fff;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease, transform 0.2s ease;
      box-shadow: 0 10px 30px rgba(82, 114, 255, 0.4);
    }
    #mode-button.visible {
      opacity: 1;
      pointer-events: auto;
    }
    #mode-button:hover {
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 15px 40px rgba(82, 114, 255, 0.5);
    }
    #mode-button:active {
      transform: translateX(-50%) translateY(0);
    }
    .arrow-controls.styles {
      top: 45%;
      left: 0;
      right: 0;
    }
    /* Filter selection screen */
    #filter-overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 50%;
      height: 100%;
      background: rgba(9, 11, 18, 0.95);
      backdrop-filter: blur(20px);
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      z-index: 150;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      overflow: hidden;
    }
    #filter-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 768px) {
      #filter-overlay {
        width: 100%;
      }
    }
    /* iPad portrait - full screen filter overlay */
    @media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
      #filter-overlay {
        width: 100%;
      }
    }
    #filter-content {
      max-width: 500px;
      margin: 0 auto;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 40px;
      box-sizing: border-box;
      overflow-y: auto;
      padding-bottom: 100px;
    }
    #filter-content h2 {
      font-size: 32px;
      font-weight: 300;
      letter-spacing: -0.5px;
      margin: 0 0 32px 0;
      color: #e6e9f2;
    }
    #filter-selected {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 32px;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #filter-selected.empty {
      opacity: 0.5;
    }
    .filter-selected-label {
      font-size: 12px;
      font-weight: 500;
      color: rgba(230, 233, 242, 0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .filter-selected-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .filter-selected-tag {
      background: rgba(63, 94, 251, 0.15);
      border: 1px solid rgba(106, 133, 255, 0.3);
      color: #9fb3ff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
    }
    #filter-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 50%;
      background: rgba(9, 11, 18, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding: 20px 40px;
      display: flex;
      gap: 16px;
      z-index: 151;
      box-sizing: border-box;
    }
    @media (max-width: 768px) {
      #filter-footer {
        width: 100%;
        padding: 16px 20px;
      }
    }
    @media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
      #filter-footer {
        width: 100%;
      }
    }
    #reset-filters-button {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(230, 233, 242, 0.8);
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #reset-filters-button:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
      color: rgba(230, 233, 242, 1);
    }
    #apply-filters-button {
      flex: 1;
      background: linear-gradient(135deg, #3f5efb 0%, #6a85ff 100%);
      border: none;
      color: #fff;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 15px rgba(82, 114, 255, 0.3);
    }
    #apply-filters-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(82, 114, 255, 0.4);
    }
    #apply-filters-button:active {
      transform: translateY(0);
    }
    /* Center filter text on smaller devices */
    @media (max-width: 768px) {
      #filter-content {
        text-align: center;
      }
      #filter-content h2 {
        text-align: center;
      }
      .filter-category h3 {
        text-align: center;
      }
    }
    /* Center filter text on iPad portrait */
    @media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
      #filter-content {
        text-align: center;
      }
      #filter-content h2 {
        text-align: center;
      }
      .filter-category h3 {
        text-align: center;
      }
    }
    .filter-category {
      margin-bottom: 32px;
    }
    .filter-category h3 {
      font-size: 16px;
      font-weight: 500;
      margin: 0 0 16px 0;
      color: rgba(230, 233, 242, 0.8);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .filter-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }
    .filter-option {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: rgba(230, 233, 242, 0.9);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px 20px;
      text-align: center;
      min-height: 48px;
    }
    .filter-option:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.15);
    }
    .filter-option.selected {
      background: rgba(63, 94, 251, 0.15);
      border-color: rgba(106, 133, 255, 0.4);
      color: #9fb3ff;
    }
    .filter-option-title {
      font-size: 14px;
      font-weight: 500;
      margin: 0;
      text-transform: capitalize;
    }
    /* Toast removed */
    
    /* Primary Carousel Control - Single centered control */
    #primary-carousel-control {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      align-items: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #primary-carousel-control.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .primary-carousel-btn {
      width: 56px;
      height: 56px;
      background: rgba(9, 11, 18, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0;
    }
    .primary-carousel-btn:hover {
      background: rgba(9, 11, 18, 0.85);
      border-color: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    .primary-carousel-btn::before {
      content: '';
      display: block;
      width: 18px;
      height: 18px;
      border-top: 3px solid rgba(230, 233, 242, 0.85);
      border-right: 3px solid rgba(230, 233, 242, 0.85);
      transition: all 0.3s ease;
    }
    .primary-carousel-btn.left::before {
      transform: rotate(-135deg);
    }
    .primary-carousel-btn.right::before {
      transform: rotate(45deg);
    }
    .primary-carousel-btn:hover::before {
      border-color: rgba(230, 233, 242, 1);
    }
    .primary-carousel-btn.left:hover::before {
      transform: rotate(-135deg) translateX(-3px);
    }
    .primary-carousel-btn.right:hover::before {
      transform: rotate(45deg) translateX(3px);
    }
    
    /* Build Mode Tabs */
    #build-mode-tabs {
      position: absolute;
      bottom: 160px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      background: rgba(9, 11, 18, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 6px;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #build-mode-tabs.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .build-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: rgba(230, 233, 242, 0.6);
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.3px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-family: inherit;
      text-transform: capitalize;
    }
    .build-tab:hover {
      color: rgba(230, 233, 242, 0.8);
      background: rgba(255, 255, 255, 0.05);
    }
    .build-tab.active {
      background: rgba(106, 133, 255, 0.2);
      color: #9fb3ff;
    }
    
    /* Product Card Overlay */
    /* Product Cards Backdrop (for mobile overlay) */
    #product-cards-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 150;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    #product-cards-backdrop.visible {
      opacity: 1;
      pointer-events: auto;
    }
    
    /* Product Cards Toggle Button (for mobile/narrow screens) */
    #product-cards-toggle {
      position: fixed;
      right: 16px;
      bottom: 80px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      color: #000;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 140;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      font-family: inherit;
      padding: 0;
      filter: grayscale(100%) contrast(1.2);
    }
    
    #product-cards-toggle:hover {
      background: rgba(255, 255, 255, 1);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }
    
    #product-cards-toggle.active {
      background: rgba(0, 0, 0, 0.9);
      border-color: rgba(0, 0, 0, 0.3);
      color: #fff;
      filter: grayscale(0%);
    }
    
    /* Product Cards Container (for Collections/Build mode) */
    #product-cards-container {
      position: fixed;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 160;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      max-width: 280px;
    }
    
    /* Individual product cards can be shown/hidden */
    .product-card[data-type] {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    .product-card.hidden {
      display: none;
    }
    
    #product-cards-container.visible {
      opacity: 1;
      pointer-events: auto;
    }
    
    #product-cards-container.visible .product-card {
      pointer-events: auto;
    }
    
    .product-card {
      width: 260px;
      background: rgba(9, 11, 18, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px;
      box-sizing: border-box;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .product-card-left {
      flex: 1;
      min-width: 0;
    }
    
    .product-card-right {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-shrink: 0;
      margin-top: 4px;
    }
    
    .product-name {
      font-size: 13px;
      font-weight: 500;
      color: #e6e9f2;
      margin: 0 0 6px 0;
      line-height: 1.4;
    }
    
    .product-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 2px;
    }
    
    .product-tag {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      font-size: 10px;
      color: rgba(230, 233, 242, 0.7);
      font-weight: 400;
    }
    
    .product-price {
      font-size: 15px;
      font-weight: 500;
      color: #e6e9f2;
      white-space: nowrap;
    }
    
    .product-add-cart-btn {
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      font-size: 10px;
      font-weight: 500;
      color: #e6e9f2;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      white-space: nowrap;
    }
    
    .product-add-cart-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }
    
    /* Style Card (for Looks mode) - matches collections format */
    #style-card {
      position: fixed;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      width: 260px;
      background: rgba(9, 11, 18, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 160;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 280px;
    }
    
    #style-card.visible {
      opacity: 1;
      pointer-events: auto;
    }
    
    .style-name {
      font-size: 13px;
      font-weight: 500;
      color: #e6e9f2;
      margin: 0 0 6px 0;
      line-height: 1.4;
    }
    
    .style-description {
      font-size: 11px;
      color: rgba(230, 233, 242, 0.7);
      line-height: 1.4;
      margin: 0 0 4px 0;
    }
    
    .style-card-right {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }
    
    .style-total-price {
      font-size: 15px;
      font-weight: 500;
      color: #e6e9f2;
      white-space: nowrap;
    }
    
    .style-add-cart-btn {
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      font-size: 10px;
      font-weight: 500;
      color: #e6e9f2;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      white-space: nowrap;
    }
    
    .style-add-cart-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }
    
    /* Medium screens - reduce card width */
    @media (max-width: 1024px) and (min-width: 769px) {
      #style-card {
        right: 20px;
        max-width: 260px;
        width: 260px;
        padding: 12px;
      }
    }
    
    /* Medium screens - reduce card width */
    @media (max-width: 1024px) and (min-width: 769px) {
      #style-card {
        right: 20px;
        max-width: 260px;
        width: 260px;
        padding: 12px;
      }
    }
    
    /* Narrow screens - show toggle button and modal overlay */
    @media (max-width: 768px) {
      #style-card {
        position: fixed;
        right: 0;
        left: 0;
        bottom: 0;
        top: auto;
        transform: translateY(100%);
        width: 100%;
        max-width: 100%;
        border-radius: 20px 20px 0 0;
        padding: 16px;
        background: rgba(9, 11, 18, 0.98);
        backdrop-filter: blur(20px);
        max-height: 70vh;
        overflow-y: auto;
      }
      
      #style-card.visible {
        transform: translateY(0);
      }
      
      .style-name {
        font-size: 13px;
      }
      
      .style-description {
        font-size: 11px;
      }
      
      .style-total-price {
        font-size: 15px;
      }
      
      .style-add-cart-btn {
        font-size: 10px;
        padding: 5px 10px;
      }
    }
    
    /* Dresses Card Container - same styling as product cards */
    #dresses-card-container {
      position: fixed;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 160;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      max-width: 280px;
    }

    #dresses-card-container.visible {
      opacity: 1;
      pointer-events: auto;
    }

    #dresses-card-container .product-card {
      width: 260px;
    }
    
    @media (max-width: 1024px) and (min-width: 769px) {
      #dresses-card-container {
        right: 20px;
        max-width: 260px;
      }
      
      #dresses-card-container .product-card {
        width: 260px;
        padding: 12px;
      }
    }
    
    @media (max-width: 768px) {
      #dresses-card-container {
        position: fixed;
        right: 0;
        left: 0;
        bottom: 0;
        top: auto;
        transform: translateY(100%);
        width: 100%;
        max-width: 100%;
        max-height: 70vh;
        padding: 16px;
        border-radius: 20px 20px 0 0;
        background: rgba(9, 11, 18, 0.98);
        backdrop-filter: blur(20px);
        overflow-y: auto;
      }
      
      #dresses-card-container.visible {
        transform: translateY(0);
      }
      
      #dresses-card-container .product-card {
        width: 100%;
        padding: 12px;
      }
    }
    
    /* Very narrow screens */
    @media (max-width: 480px) {
      #style-card {
        max-height: 75vh;
        padding: 12px;
      }
    }
    #product-cards-container::-webkit-scrollbar {
      width: 6px;
    }
    #product-cards-container::-webkit-scrollbar-track {
      background: transparent;
    }
    #product-cards-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    /* Medium screens - reduce card width */
    @media (max-width: 1024px) and (min-width: 769px) {
      #product-cards-container {
        right: 20px;
        max-width: 260px;
      }
      
      .product-card {
        width: 260px;
        padding: 12px;
      }
    }
    
    /* Narrow screens - show toggle button and modal overlay */
    @media (max-width: 768px) {
      #product-cards-toggle {
        display: flex;
      }
      
      #product-cards-container {
        position: fixed;
        right: 0;
        left: 0;
        top: auto;
        bottom: 0;
        transform: translateY(100%);
        width: 100%;
        max-width: 100%;
        max-height: 70vh;
        gap: 10px;
        padding: 16px;
        border-radius: 20px 20px 0 0;
        background: rgba(9, 11, 18, 0.98);
        backdrop-filter: blur(20px);
        overflow-y: auto;
      }
      
      #product-cards-container.visible {
        transform: translateY(0);
      }
      
      .product-card {
        width: 100%;
        padding: 12px;
        flex-direction: column;
        gap: 10px;
      }
      
      .product-card-right {
        align-items: flex-start;
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
      }
      
      .product-name {
        font-size: 13px;
      }
      
      .product-price {
        font-size: 15px;
      }
      
      .product-tag {
        font-size: 10px;
        padding: 3px 8px;
      }
      
      .product-add-cart-btn {
        font-size: 10px;
        padding: 5px 10px;
      }
    }
    
    /* iPad portrait - show toggle button */
    @media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
      #product-cards-toggle {
        display: flex;
      }
    }
    
    /* Very narrow screens */
    @media (max-width: 480px) {
      #product-cards-toggle {
        right: 12px;
        bottom: 70px;
        width: 36px;
        height: 36px;
        font-size: 16px;
      }
      
      #product-cards-container {
        max-height: 75vh;
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <canvas id="canvas"></canvas>
    <div id="topbar">
      <div class="topbar-left">
        <div class="wordmark">mirim</div>
      </div>
      <div class="topbar-center">
        <a href="#" class="nav-link" id="nav-styles">Styles</a>
        <a href="#" class="nav-link" id="nav-collection">Collection</a>
        <a href="#" class="nav-link" id="nav-dresses">Dresses</a>
      </div>
      <div class="topbar-right">
        <button class="nav-button" id="request-demo-button">
          <span class="demo-text-full">Request demo</span>
          <span class="demo-text-short">Demo</span>
        </button>
      </div>
      <div id="status-pill" class="status-pill hidden">
        <div class="loading-spinner"></div>
        <span class="status-text"></span>
        <button class="status-retry hidden">Retry</button>
      </div>
    </div>
    <div id="intro-overlay">
      <div id="intro-content">
        <h1>Curate Your Style</h1>
        <p class="subhead">Discover curated capsules and designer pieces in an immersive 3D experience.</p>
        <p class="credibility">Curated Capsules â€¢ Designer Boutiques</p>
        <p class="beta-tag">Beta</p>
        <button id="intro-start-button">Start</button>
      </div>
    </div>
    <div id="demo-modal">
      <div class="demo-modal-content">
        <button class="demo-modal-close" id="demo-modal-close">&times;</button>
        <div class="demo-modal-header">
          <h2 id="demo-modal-title">Request a Demo</h2>
          <p id="demo-modal-subtitle">We'll get back to you soon</p>
        </div>
        <form class="demo-modal-form" id="demo-form">
          <div id="demo-form-content">
            <input type="email" name="email" class="demo-modal-input" id="demo-email" placeholder="your@email.com" required />
            <div class="demo-modal-actions">
              <button type="button" class="demo-modal-button cancel" id="demo-modal-cancel">Cancel</button>
              <button type="submit" class="demo-modal-button send" id="demo-submit-button">Send</button>
            </div>
          </div>
          <div id="demo-success-message" class="demo-success-message hidden">
            <p>Thank you! We'll be in touch soon.</p>
          </div>
        </form>
      </div>
    </div>
    <!-- Individual arrow controls for each clothing type -->
    <div class="arrow-controls shirts visible" data-type="shirts" id="shirts-controls">
      <button class="arrow-btn left" data-type="shirts" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="shirts" data-dir="1"></button>
      </div>
    <div class="arrow-controls pants visible" data-type="pants">
      <button class="arrow-btn left" data-type="pants" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="pants" data-dir="1"></button>
      </div>
    <div class="arrow-controls shoes visible" data-type="shoes">
      <button class="arrow-btn left" data-type="shoes" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="shoes" data-dir="1"></button>
      </div>
    <div class="arrow-controls dresses" data-type="dresses">
      <button class="arrow-btn left" data-type="dresses" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="dresses" data-dir="1"></button>
    </div>
    <div class="arrow-controls styles" data-type="styles" id="styles-controls">
      <button class="arrow-btn left" data-type="styles" data-dir="-1"></button>
      <button class="arrow-btn right" data-type="styles" data-dir="1"></button>
    </div>
    
    <!-- Primary Carousel Control (for Looks and Dresses modes) -->
    <div id="primary-carousel-control">
      <button class="primary-carousel-btn left" id="primary-carousel-left"></button>
      <button class="primary-carousel-btn right" id="primary-carousel-right"></button>
    </div>
    
    <!-- Style Card (for Looks mode) -->
    <div id="style-card">
      <div class="style-name" id="style-name">Style Name</div>
      <div class="style-description" id="style-description">Style description</div>
      <div class="style-card-right">
        <div class="style-total-price" id="style-total-price">$0</div>
        <button class="style-add-cart-btn">Add to Cart</button>
      </div>
    </div>
    
    <!-- Dresses Card (for Dresses mode) -->
    <div id="dresses-card-container">
      <div class="product-card" data-type="dresses" id="product-card-dresses">
        <div class="product-card-left">
          <div class="product-name" id="product-name-dresses">Item Name</div>
          <div class="product-tags" id="product-tags-dresses"></div>
        </div>
        <div class="product-card-right">
          <div class="product-price" id="product-price-dresses">$0</div>
          <button class="product-add-cart-btn">Add to Cart</button>
        </div>
      </div>
      <div class="product-card" data-type="shoes" id="product-card-shoes-dresses">
        <div class="product-card-left">
          <div class="product-name" id="product-name-shoes-dresses">Item Name</div>
          <div class="product-tags" id="product-tags-shoes-dresses"></div>
        </div>
        <div class="product-card-right">
          <div class="product-price" id="product-price-shoes-dresses">$0</div>
          <button class="product-add-cart-btn">Add to Cart</button>
        </div>
      </div>
    </div>

    <!-- Product Cards Overlay (for Collections/Build mode) -->
    <div id="product-cards-backdrop"></div>
    <button id="product-cards-toggle" aria-label="Toggle product details">i</button>
    <div id="product-cards-container">
      <!-- Shirts Card -->
      <div class="product-card" data-type="shirts" id="product-card-shirts">
        <div class="product-card-left">
          <div class="product-name" id="product-name-shirts">Item Name</div>
          <div class="product-tags" id="product-tags-shirts"></div>
        </div>
        <div class="product-card-right">
          <div class="product-price" id="product-price-shirts">$0</div>
          <button class="product-add-cart-btn">Add to Cart</button>
        </div>
      </div>
      
      <!-- Pants Card -->
      <div class="product-card" data-type="pants" id="product-card-pants">
        <div class="product-card-left">
          <div class="product-name" id="product-name-pants">Item Name</div>
          <div class="product-tags" id="product-tags-pants"></div>
        </div>
        <div class="product-card-right">
          <div class="product-price" id="product-price-pants">$0</div>
          <button class="product-add-cart-btn">Add to Cart</button>
        </div>
      </div>
      
      <!-- Shoes Card -->
      <div class="product-card" data-type="shoes" id="product-card-shoes">
        <div class="product-card-left">
          <div class="product-name" id="product-name-shoes">Item Name</div>
          <div class="product-tags" id="product-tags-shoes"></div>
        </div>
        <div class="product-card-right">
          <div class="product-price" id="product-price-shoes">$0</div>
          <button class="product-add-cart-btn">Add to Cart</button>
        </div>
      </div>
    </div>
    <div id="filter-overlay">
      <div id="filter-content">
        <h2>Build Your Look</h2>
        <div id="filter-selected" class="empty">
          <div class="filter-selected-label">Selected</div>
          <div class="filter-selected-items" id="filter-selected-items"></div>
        </div>
        <div class="filter-category">
          <h3>Tops</h3>
          <div class="filter-options" id="tops-options">
            <button class="filter-option" data-filter="shirt">
              <div class="filter-option-title">Shirts</div>
            </button>
            <button class="filter-option" data-filter="jacket">
              <div class="filter-option-title">Jackets</div>
            </button>
          </div>
        </div>
        <div class="filter-category">
          <h3>Bottoms</h3>
          <div class="filter-options" id="bottoms-options">
            <button class="filter-option" data-filter="shorts">
              <div class="filter-option-title">Shorts</div>
            </button>
            <button class="filter-option" data-filter="skirt">
              <div class="filter-option-title">Skirts</div>
            </button>
            <button class="filter-option" data-filter="jeans">
              <div class="filter-option-title">Jeans</div>
            </button>
            <button class="filter-option" data-filter="leggings">
              <div class="filter-option-title">Leggings</div>
            </button>
            <button class="filter-option" data-filter="pants">
              <div class="filter-option-title">Pants</div>
            </button>
          </div>
        </div>
        <div class="filter-category">
          <h3>Shoes</h3>
          <div class="filter-options" id="shoes-options">
            <button class="filter-option" data-filter="basketball">
              <div class="filter-option-title">Basketball</div>
            </button>
            <button class="filter-option" data-filter="tennis">
              <div class="filter-option-title">Tennis</div>
            </button>
            <button class="filter-option" data-filter="dress">
              <div class="filter-option-title">Dress</div>
            </button>
            <button class="filter-option" data-filter="dunks">
              <div class="filter-option-title">Dunks</div>
            </button>
          </div>
        </div>
      </div>
      <div id="filter-footer">
        <button id="reset-filters-button">Reset</button>
        <button id="apply-filters-button">Apply</button>
      </div>
    </div>
  </div>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
      }
    }
    </script>
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";
    import { RoomEnvironment } from "https://unpkg.com/three@0.160.0/examples/jsm/environments/RoomEnvironment.js";

    // Assets manifest - inline dictionary (no separate file needed)
    const manifest = {
      shirts: [
        "UNIQLO_Sweater.glb",
        "UNIQLO_Airism_Button_Down.glb",
        "Graphic_UNIQLO_Tee.glb",
        "White_Tee.glb",
        "Ski_Jacket.glb",
        "Womens_Puffer.glb",
        "Womens_Fleece_Jacket.glb",
        "Puffy_Down_Jacket.glb",
        "Womens_Full_Zip.glb"
      ],
      pants: [
        "Womens_Linen_Dress_Pants.glb",
        "Linen_Pants.glb",
        "Cargo_Pants.glb",
        "UNIQLO_Dress_Fit_Pants.glb",
        "Active_Wear_Linen_Pants.glb",
        "Womens_Suit_Pants.glb",
        "Fabletics_Leggings.glb",
        "Lululemon_Leggings.glb",
        "Mens_Modern-Fit_Resolution_Pants.glb",
        "Heather_Slim_Fit_Dress_Pant.glb",
        "Flared_Jeans.glb",
        "Flared_Slim_Fit_Jeans.glb",
        "Womens_Slim_Fit_Jeans.glb",
        "AE_AirFlex+_Slim_Straight_Jean.glb",
        "Straight_Jeans.glb",
        "Mens_Loose_Jeans.glb"
      ],
      shoes: [
        "Nike_Dunks_Tan.glb",
        "High_Top_Dunks.glb",
        "Leather_Oxford_Shoes.glb",
        "Black_Stilleto_Heels.glb",
        "Hoop_Heels.glb",
        "Adidas_Barricades.glb",
        "Adidas_Basketball_Shoes.glb",
        "Adidas_Furies.glb",

      ],
      dresses: [
        "Boat-Neck_Tie_Maxi_Dress.glb",
        "Boat-Neck_Tie-Gather_Maxi_Dress.glb",
        "Off_Shoulder_Maxi_Dress.glb",
        "Black_Strapless_Dress.glb",
        "Ruffled_Scoopneck_Mini_Dress.glb"
      ],
      shorts: [
        "Mens_Shorts.glb",
        "Cargo_Shorts.glb",
        "Womens_Jean_Shorts.glb",
        "Cotton_Shorts_Women.glb",
        "Skirt.glb",
        "Pencil_Skirt.glb"
      ]
    };
    const BASE = new URL(".", window.location.href); // e.g. https://shrishchou.github.io/YC_Fashion/

    function u(path) {
      return new URL(path.replace(/^\/+/, ""), BASE).toString(); // strips any leading /
    }

    const assets = {
      shirts:  (manifest.shirts  ?? []).map(f => u(`shirts/${f}`)),
      pants:   (manifest.pants   ?? []).map(f => u(`pants/${f}`))
                .concat((manifest.shorts ?? []).map(f => u(`shorts/${f}`))),
      shoes:   (manifest.shoes   ?? []).map(f => u(`shoes/${f}`)),
      dresses: (manifest.dresses ?? []).map(f => u(`dresses/${f}`)),
    };
    
    // Store original asset order (deep copy for later randomization)
    const originalAssets = {
      shirts: [...assets.shirts],
      pants: [...assets.pants],
      shoes: [...assets.shoes],
      dresses: [...assets.dresses]
    };
    
    // Helper to check if an item is a short
    function isShort(filepath) {
      return filepath.includes('/shorts/');
    }
    
    // Build asset paths from manifest dictionary
    const pantsItems = manifest.pants ? manifest.pants.map(file => `/pants/${file}`) : [];
    const shortsItems = manifest.shorts ? manifest.shorts.map(file => `/shorts/${file}`) : [];
    
    // Build full paths from manifest
    // const assets = {
    //   shirts: manifest.shirts ? manifest.shirts.map(file => `/shirts/${file}`) : [],
    //   pants: [...pantsItems, ...shortsItems], // Combine pants and shorts
    //   shoes: manifest.shoes ? manifest.shoes.map(file => `/shoes/${file}`) : [],
    //   dresses: manifest.dresses ? manifest.dresses.map(file => `/dresses/${file}`) : []
    // };
    
    console.log("Loaded assets from manifest:", assets);

    // Vertical offsets to stack items vertically
    // Each item will rotate around its own center at its vertical position
    const verticalOffsets = {
      shoes: 0,      // at ground level
      pants: 1.2,    // above shoes
      shirts: 3.3,   // above pants
      dresses: 2,  // higher position for dresses
    };

    // No horizontal or depth offsets - items stay centered on X and Z
    const zOffsets = {
      shoes: 0,
      pants: 0,
      shirts: 0,
      dresses: 0,
    };

    const xOffsets = {
      shoes: 0,
      pants: 0,
      shirts: 0,
      dresses: 0,
    };

    // Mobile detection (needed for positioning)
    // Include iPad portrait (768-1024px width in portrait orientation) as mobile behavior
    const isIPadPortrait = window.innerWidth >= 769 && window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768 || isIPadPortrait;

    // Position constants
    // On mobile, start from left; on desktop, start from right
    const rightCenterX = 2.5; // initial position (on the right side of screen - desktop)
    const leftCenterX = -2.5; // initial position (on the left side of screen - mobile)
    const targetCenterX = 0; // final center position
    const rightCenterY = -0.5; // initial Y position (lower when on the right)
    const leftCenterY = -0.5; // initial Y position (lower when on the left)
    const targetCenterY = 0; // final Y position (normal center height)
    
    // Set initial position - always start in center (no side positioning)
    const initialX = targetCenterX;
    const initialY = targetCenterY;

    const scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x090b12, 12, 30);

    const canvas = document.getElementById("canvas");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.1;
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    const camera = new THREE.PerspectiveCamera(25, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, 7.0, 14);
    scene.add(camera);

    const pmrem = new THREE.PMREMGenerator(renderer);
    scene.environment = pmrem.fromScene(new RoomEnvironment(renderer), 0.02).texture;

    const controls = new OrbitControls(camera, renderer.domElement);
    // Keep camera looking at center initially, items will be on the right
    controls.target.set(0, 3.0, 0);
    controls.enableDamping = true;
    controls.minDistance = 4;
    controls.maxDistance = 14;
    controls.enablePan = false; // Disable panning to prevent target drift
    
    // Feature 8: Stop auto-rotate during interaction, resume after 3 seconds idle
    controls.addEventListener('start', function() {
      rotationController.pause();
    });
    
    controls.addEventListener('change', function() {
      rotationController.pause();
      rotationController.resumeAfterIdle();
    });
    
    controls.addEventListener('end', function() {
      rotationController.resumeAfterIdle();
    });
    controls.maxPolarAngle = Math.PI * 0.55;
    
    // Store initial camera and controls state for resetting per experience
    const initialCameraPosition = new THREE.Vector3(0, 7.0, 14);
    const initialControlsTarget = new THREE.Vector3(0, 3.0, 0);
    
    // Function to reset camera and controls to initial state
    function resetCameraAndControls() {
      camera.position.copy(initialCameraPosition);
      controls.target.copy(initialControlsTarget);
      controls.update();
    }

    const hemiLight = new THREE.HemisphereLight(0x8fb2ff, 0x0b0d14, 0.75);
    hemiLight.position.set(0, 6, 0);
    scene.add(hemiLight);

    const keyLight = new THREE.DirectionalLight(0xffffff, 1.35);
    keyLight.position.set(6, 8, 8);
    keyLight.castShadow = true;
    keyLight.shadow.mapSize.set(2048, 2048);
    keyLight.shadow.bias = -0.0005;
    scene.add(keyLight);

    const rimLight = new THREE.DirectionalLight(0x96b3ff, 0.5);
    rimLight.position.set(-5, 4, -4);
    scene.add(rimLight);

    // Front left light at midway height
    const frontLeftLight = new THREE.DirectionalLight(0xffffff, 0.8);
    frontLeftLight.position.set(-3, 1, 3); // Front left, at midway height (around 3.5)
    scene.add(frontLeftLight);

    const loader = new GLTFLoader();
    const current = { shirts: 0, pants: 0, shoes: 0, dresses: 0 };
    
    // Mode state: 'casual' (shirts+pants), 'dresses', or 'styles'
    // Experience state - single source of truth
    // States: "home", "looks", "build", "dresses"
    let currentExperience = 'home';
    
    // Build mode tab state
    let currentBuildTab = 'shirts'; // 'shirts', 'pants', 'shoes'
    
    // Currently selected clothing type for product card display
    let currentSelectedClothing = 'shirts'; // 'shirts', 'pants', 'shoes'
    
    // Filter state
    let selectedFilters = {
      tops: [],
      bottoms: [],
      shoes: []
    };
    
    // Store last applied filters to remember them when going back
    let lastAppliedFilters = {
      tops: [],
      bottoms: [],
      shoes: []
    };
    
    // Style metadata with name, description, and pricing
    const styleMetadata = [
      {
        name: "Essential Classic",
        description: "Timeless pieces that form the foundation of any wardrobe",
        totalPrice: 387,
        itemPrices: { shirt: 129, pant: 159, shoe: 99 }
      },
      {
        name: "Evening Elegance",
        description: "Sophisticated maxi dress paired with elegant heels",
        totalPrice: 270,
        itemPrices: { dress: 170, shoe: 100 }
      },
      {
        name: "City Minimal",
        description: "Clean lines and sophisticated neutrals for urban elegance",
        totalPrice: 395,
        itemPrices: { shirt: 145, pant: 151, shoe: 99 }
      },
      {
        name: "Garden Party",
        description: "Flowing dress with statement heels for special occasions",
        totalPrice: 275,
        itemPrices: { dress: 175, shoe: 100 }
      },
      {
        name: "Weekend Casual",
        description: "Relaxed comfort meets effortless style",
        totalPrice: 357,
        itemPrices: { shirt: 129, pant: 129, shoe: 99 }
      },
      {
        name: "Evening Edge",
        description: "Bold statement pieces for night-time sophistication",
        totalPrice: 423,
        itemPrices: { shirt: 169, pant: 155, shoe: 99 }
      },
      {
        name: "Desert Wanderer",
        description: "Earth tones and textured fabrics for modern exploration",
        totalPrice: 408,
        itemPrices: { shirt: 149, pant: 160, shoe: 99 }
      },
      {
        name: "Coastal Breeze",
        description: "Lightweight layers perfect for seaside escapes",
        totalPrice: 374,
        itemPrices: { shirt: 129, pant: 146, shoe: 99 }
      }
    ];
    
    // Pre-defined style combinations (matches metadata array length)
    // If dress is defined (>= 0), it's a dress style (dress + shoes)
    // If dress is -1, it's a regular style (shirt + pants + shoes)
    const styleCombinations = [
      { shirt: 0, pant: 0, shoe: 0, dress: -1 },
      { dress: 0, shoe: 3, shirt: -1, pant: -1 }, // Dress with heels (second style) - Black_Stilleto_Heels is index 3
      { shirt: 1, pant: 8, shoe: 0, dress: -1 },
      { dress: 2, shoe: 4, shirt: -1, pant: -1 }, // Dress with heels (fourth style) - Hoop_Heels is index 4
      { shirt: 4, pant: 2, shoe: 1, dress: -1 },
      { shirt: 2, pant: 1, shoe: 0, dress: -1 },
      { shirt: 0, pant: 2, shoe: 5, dress: -1 } 
    ];
    let currentStyleIndex = 0;
    
    // Carousel structure: each type has 3 slots (prev, current, next)
    const carouselSlots = {
      shirts: { prev: new THREE.Group(), current: new THREE.Group(), next: new THREE.Group() },
      pants: { prev: new THREE.Group(), current: new THREE.Group(), next: new THREE.Group() },
      shoes: { prev: new THREE.Group(), current: new THREE.Group(), next: new THREE.Group() },
      dresses: { prev: new THREE.Group(), current: new THREE.Group(), next: new THREE.Group() }
    };
    
    // Carousel configuration - must be declared before use
    // The pivot point is behind the current item, and items rotate around this pivot
    const CAROUSEL_PIVOT_BACK = 4.5; // How far behind the center item the pivot should be (larger = pivot further back)
    const CAROUSEL_RADIUS = CAROUSEL_PIVOT_BACK; // Distance from pivot to items (should match pivot distance for proper centering)
    const CAROUSEL_ANGLE = Math.PI / 4.5; // ~40 degrees between items (~20 degrees each side)
    const CAROUSEL_SCALE_SIDE = 0.75; // Scale for prev/next items
    
    // Carousel groups - each type has its own carousel group that rotates
    const carouselGroups = {
      shirts: new THREE.Group(),
      pants: new THREE.Group(),
      shoes: new THREE.Group(),
      dresses: new THREE.Group()
    };
    
      // Add all slots to their respective carousel groups
      Object.keys(carouselSlots).forEach(type => {
        carouselGroups[type].add(
          carouselSlots[type].prev,
          carouselSlots[type].current,
          carouselSlots[type].next
        );
        // Position items at origin (no carousel offset)
        carouselGroups[type].position.z = 0;
      });
    
    // Legacy groups for backward compatibility with welcome animation
    const groups = { 
      shirts: carouselGroups.shirts, 
      pants: carouselGroups.pants,
      shoes: carouselGroups.shoes,
      dresses: carouselGroups.dresses
    };
    
    // Master group to hold all clothing for easy translation and rotation
    const clothingGroup = new THREE.Group();
    clothingGroup.add(groups.shirts, groups.pants, groups.shoes, groups.dresses);
    scene.add(clothingGroup);
    
    // Initial position: right-center (translated to the right and lower)
    clothingGroup.position.x = initialX;
    clothingGroup.position.y = initialY;
    
    // Rotation Controller - single source of truth for rotation
    const rotationController = {
      enabled: true,
      speed: 0.005, // radians per frame
      globalAngle: 0, // Single shared angle for all items
      idleTimer: null,
      idleDelay: 3000, // 3 seconds
      // Get current rotation angle (shared across all items)
      getAngle: function() {
        return this.globalAngle;
      },
      // Update rotation angle (shared across all items)
      setAngle: function(angle) {
        this.globalAngle = angle;
      },
      // Increment rotation angle (called in animate loop)
      increment: function() {
        if (this.enabled) {
          this.globalAngle += this.speed;
        }
      },
      // Stop auto-rotation and start idle timer
      pause: function() {
        this.enabled = false;
        if (this.idleTimer) {
          clearTimeout(this.idleTimer);
        }
      },
      // Resume auto-rotation after idle delay
      resumeAfterIdle: function() {
        const self = this;
        if (this.idleTimer) {
          clearTimeout(this.idleTimer);
        }
        this.idleTimer = setTimeout(function() {
          self.enabled = true;
        }, this.idleDelay);
      }
    };

    // Toast notifications removed - no longer showing
    function showToast(message) {
      // Toast functionality disabled
      console.log(message); // Log to console instead
    }

    function separateShoes(object) {
      // Collect all mesh objects that could be shoes
      const meshes = [];
      object.traverse((child) => {
        if (child.isMesh) {
          meshes.push(child);
        }
      });

      // If we have 2 or more meshes, try to separate them
      if (meshes.length >= 2) {
        // Calculate bounding boxes for each mesh
        const boxes = meshes.map((mesh) => {
          const box = new THREE.Box3().setFromObject(mesh);
          return { mesh, box, center: box.getCenter(new THREE.Vector3()) };
        });

        // Sort by x position (left to right)
        boxes.sort((a, b) => a.center.x - b.center.x);

        // Calculate the overall width
        const overallBox = new THREE.Box3().setFromObject(object);
        const overallWidth = overallBox.max.x - overallBox.min.x;

        // Separate the shoes horizontally
        const separation = Math.max(0.8, overallWidth * 0.4); // at least 0.8 units apart
        const leftShoe = boxes[0];
        const rightShoe = boxes[boxes.length - 1];

        // Move left shoe left, right shoe right
        if (leftShoe.mesh.parent) {
          leftShoe.mesh.position.x -= separation / 2;
        }
        if (rightShoe.mesh.parent && rightShoe.mesh !== leftShoe.mesh) {
          rightShoe.mesh.position.x += separation / 2;
        }
      }
    }

    function centerAndPlace(object, type, slot = 'current', url = '', index = -1) {
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      // Reset position to origin and center the model
      // This ensures rotation happens around the model's center
      object.position.set(0, 0, 0);
      object.position.sub(center); // Center model at origin

      // Calculate vertical offset to position item at its Y level
      // All items use the same vertical offset calculation - no special index handling
      let yOffset = verticalOffsets[type] - box.min.y + 0.25;
      
      // Apply vertical offset - item's center will be at (0, yOffset, 0)
      // This allows each item to rotate around its own center at its vertical position
      object.position.y += yOffset;

      // Apply additional vertical offset for last two dresses (indices 3 and 4)
      if (type === "dresses" && (index === 3 )) {
        object.position.y += 0.4; // Move up vertically
      }
      if (type === "dresses" && (index === 4)) {
        object.position.y += 0.65; // Move up vertically
      }

      // Apply z-offset for specific items if needed
      // For Off-Shoulder dress, offset it backward (away from camera)
      if (type === "dresses" && (url.toLowerCase().includes('off_shoulder') || url.toLowerCase().includes('off-shoulder'))) {
        object.position.z -= 0.2; // Move backward (positive Z is away from camera)
      }

      // Determine scale based on type
      let scaleTarget = 1.0;
      
      if (type === "shoes") {
        // Scale down heels
        if (url.toLowerCase().includes('heels')) {
          scaleTarget = 0.4;
        } else if (url.toLowerCase().includes('dresswomensshoes')) {
          scaleTarget = 0.4;
        } else if (url.toLowerCase().includes('basketball_shoes')) {
          scaleTarget = 0.45; // Scale down Adidas Furies slightly
        } else {
          scaleTarget = 0.5;
        }
      } else if (type === "pants") {
        // Check if this is a short based on file path
        const isAShort = isShort(url);
        scaleTarget = isAShort ? 0.6 : 1.2;
        // Shorts may need slight vertical adjustment
        if (isAShort) {
          object.position.y += 0.7;
        }
      } else if (type === "dresses") {
        // Dresses are scaled up - first two dresses are larger, others are also scaled up
        scaleTarget = (index === 0 || index === 1||index===2) ? 1.8 : 1.3;
      } else if (type === "shirts") {
        // Check for specific items that need different scaling
        if (url.toLowerCase().includes('puffy_down_jacket') || url.toLowerCase().includes('puffydownjacket')) {
          scaleTarget = 1.2; // Scale up Puffy Down Jacket
        } else if (url.toLowerCase().includes('ski_jacket') || url.toLowerCase().includes('skijacket')) {
          scaleTarget = 1.2; // Scale up Ski Jacket
        } else {
          scaleTarget = 1.0; // Default scale for shirts
        }
      }
      
      // Apply scaling
      const maxDimension = Math.max(size.x, size.y, size.z);
      if (maxDimension > 0) {
        const s = (scaleTarget * 2.0) / maxDimension;
        object.scale.setScalar(s);
      }
      
      // X and Z stay at 0 - items are centered horizontally and in depth
      // Each item rotates around its own center at (0, yOffset, 0)
      // Rotation is set in loadModelToSlot to ensure all items use the same global angle
    }

    // Status pill management
    function showStatusPill(message, showRetry = false, retryCallback = null, isLoading = false) {
      const statusPill = document.getElementById('status-pill');
      const statusText = statusPill?.querySelector('.status-text');
      const statusRetry = statusPill?.querySelector('.status-retry');
      
      if (!statusPill || !statusText) return;
      
      statusText.textContent = message;
      statusPill.classList.remove('hidden');
      
      // Show spinner when loading
      if (isLoading) {
        statusPill.classList.add('loading');
      } else {
        statusPill.classList.remove('loading');
      }
      
      if (statusRetry) {
        if (showRetry && retryCallback) {
          statusRetry.classList.remove('hidden');
          statusRetry.onclick = () => {
            statusRetry.classList.add('hidden');
            retryCallback();
          };
        } else {
          statusRetry.classList.add('hidden');
        }
      }
    }
    
    function hideStatusPill() {
      const statusPill = document.getElementById('status-pill');
      if (statusPill) {
        statusPill.classList.add('hidden');
      }
    }
    
    function loadModelToSlot(type, index, slot) {
      const total = assets[type].length;
      const normalizedIndex = (index + total) % total;
      const url = assets[type][normalizedIndex];
      
      // Clear the slot IMMEDIATELY before loading to prevent showing old model
      carouselSlots[type][slot].clear();
      // Explicitly reset slot position to prevent accumulation
      carouselSlots[type][slot].position.set(0, 0, 0);
      
      // Show loading state with spinner
      showStatusPill('Loading...', false, null, true);
      
      return new Promise((resolve, reject) => {
      loader.load(
        url,
        (gltf) => {
          gltf.scene.traverse((child) => { child.castShadow = true; });
          centerAndPlace(gltf.scene, type, slot, url, normalizedIndex);
          carouselSlots[type][slot].add(gltf.scene);
          
          // Store model reference for rotation control (only for current slot)
          if (slot === 'current') {
            currentModels[type] = gltf.scene;
            // Apply current global angle to ensure all items stay aligned
            gltf.scene.rotation.y = rotationController.getAngle();
          }
          
          hideStatusPill();
          resolve(gltf.scene);
        },
        undefined,
        (err) => {
          console.error(`Failed to load ${url}`, err);
          showStatusPill('Failed to load item', true, () => {
            loadModelToSlot(type, index, slot).then(resolve).catch(reject);
          });
          reject(err);
        }
      );
      });
    }
    
    function loadAllCarouselItems(type, showAll = false) {
      const total = assets[type].length;
      const currentIndex = current[type];
      
      // Only load current item - no prev/next
      const promises = [loadModelToSlot(type, currentIndex, 'current')];
      
      return Promise.all(promises).then(() => {
        // Always hide prev/next items - only show current
        carouselSlots[type].prev.visible = false;
        carouselSlots[type].next.visible = false;
        // Toast removed
      }).catch((err) => {
          console.error("Failed to load asset. Check console.");
        return Promise.reject(err);
      });
    }
    
    // Legacy function for initial load (only show current during welcome)
    function loadModel(type, index) {
      current[type] = index;
      loadAllCarouselItems(type, false);
    }

    // Carousel rotation state
    const carouselRotationState = { shirts: 0, pants: 0, shoes: 0, dresses: 0 };
    const carouselAnimationState = { shirts: false, pants: false, shoes: false, dresses: false };
    const CAROUSEL_ROTATION_DURATION = 600; // milliseconds
    
    // Function to update item rotations as they move around the carousel
    // Simple approach: rotation directly matches the angle position on the circle
    // This creates a natural carousel effect where items rotate smoothly as they move
    function updateItemRotations(carouselType, carouselRotation) {
        // Calculate current angle positions of each slot as carousel rotates
        // As the carousel group rotates, items' positions on the circle change
        const prevAngle = -CAROUSEL_ANGLE + carouselRotation;
        const currentAngle = 0 + carouselRotation;
        const nextAngle = CAROUSEL_ANGLE + carouselRotation;
        
        // Rotation simply matches the angle position on the circle
        // This creates natural orientation as items move around the carousel
        function getRotationForAngle(angle) {
          // Normalize angle to [-Ï€, Ï€]
          let normalizedAngle = ((angle % (Math.PI * 2)) + Math.PI * 2) % (Math.PI * 2);
          if (normalizedAngle > Math.PI) normalizedAngle -= Math.PI * 2;
          return normalizedAngle;
        }
        
        // Update each slot's rotation to match its current position on the circle
        const prevSlot = carouselSlots[carouselType].prev;
        const currentSlot = carouselSlots[carouselType].current;
        const nextSlot = carouselSlots[carouselType].next;
        
        if (prevSlot.children.length > 0) {
          const scene = prevSlot.children[0];
          if (scene && scene.isObject3D) {
            scene.rotation.y = getRotationForAngle(prevAngle);
          }
        }
        
        if (currentSlot.children.length > 0) {
          const scene = currentSlot.children[0];
          if (scene && scene.isObject3D) {
            scene.rotation.y = getRotationForAngle(currentAngle);
          }
        }
        
        if (nextSlot.children.length > 0) {
          const scene = nextSlot.children[0];
          if (scene && scene.isObject3D) {
            scene.rotation.y = getRotationForAngle(nextAngle);
          }
        }
      }
    
    // Load a style combination
    function loadStyleCombination(styleIndex) {
      const style = styleCombinations[styleIndex];
      
      // Check if this is a dress style (dress >= 0) or regular style (shirt/pants)
      const isDressStyle = style.dress !== undefined && style.dress >= 0;
      
      if (isDressStyle) {
        // Dress style: load dress + shoes
        const dressIndex = Math.min(Math.max(0, style.dress), originalAssets.dresses.length - 1);
        const shoeIndex = Math.min(Math.max(0, style.shoe), originalAssets.shoes.length - 1);
        
        // For styles mode, always use original assets
        assets.dresses = [...originalAssets.dresses];
        assets.shoes = [...originalAssets.shoes];
        
        // Clear slots BEFORE setting indices to prevent showing wrong items
        carouselSlots.dresses.current.clear();
        carouselSlots.shoes.current.clear();
        
        // Set current indices
        current.dresses = dressIndex;
        current.shoes = shoeIndex;
        
        // Visibility is set in switchStyle() before this function is called
        // Load dress and shoes simultaneously
        const promises = [
          loadAllCarouselItems('dresses'),
          loadAllCarouselItems('shoes')
        ];
        
        return Promise.all(promises);
      } else {
        // Regular style: load shirt + pants + shoes
        const shirtIndex = Math.min(Math.max(0, style.shirt), originalAssets.shirts.length - 1);
        const pantIndex = Math.min(Math.max(0, style.pant), originalAssets.pants.length - 1);
        const shoeIndex = Math.min(Math.max(0, style.shoe), originalAssets.shoes.length - 1);
        
        // For styles mode, always use original assets
        assets.shirts = [...originalAssets.shirts];
        assets.pants = [...originalAssets.pants];
        assets.shoes = [...originalAssets.shoes];
        
        // Clear slots BEFORE setting indices to prevent showing wrong items
        carouselSlots.shirts.current.clear();
        carouselSlots.pants.current.clear();
        carouselSlots.shoes.current.clear();
        
        // Set current indices
        current.shirts = shirtIndex;
        current.pants = pantIndex;
        current.shoes = shoeIndex;
        
        // Visibility is set in switchStyle() before this function is called
        // Load all three items simultaneously
        const promises = [
          loadAllCarouselItems('shirts'),
          loadAllCarouselItems('pants'),
          loadAllCarouselItems('shoes')
        ];
        
        return Promise.all(promises);
      }
    }
    
    // Switch between styles
    function switchStyle(dir) {
      // Prevent rapid switching during loading
      if (carouselAnimationState.shirts || carouselAnimationState.pants || 
          carouselAnimationState.shoes || carouselAnimationState.dresses) {
        return;
      }
      
      const newIndex = (currentStyleIndex + dir + styleCombinations.length) % styleCombinations.length;
      const newStyle = styleCombinations[newIndex];
      const isDressStyle = newStyle.dress !== undefined && newStyle.dress >= 0;
      
      // Get current style to check if we're switching types
      const currentStyle = styleCombinations[currentStyleIndex];
      const wasDressStyle = currentStyle.dress !== undefined && currentStyle.dress >= 0;
      
      // Set visibility IMMEDIATELY and atomically before loading to prevent flashing
      if (isDressStyle) {
        // Dress style: hide shirts/pants, show dresses/shoes
        if (groups.shirts) groups.shirts.visible = false;
        if (groups.pants) groups.pants.visible = false;
        if (groups.dresses) groups.dresses.visible = true;
        if (groups.shoes) groups.shoes.visible = true;
      } else {
        // Regular style: hide dresses, show shirts/pants/shoes
        if (groups.dresses) groups.dresses.visible = false;
        if (groups.shirts) groups.shirts.visible = true;
        if (groups.pants) groups.pants.visible = true;
        if (groups.shoes) groups.shoes.visible = true;
      }
      
      // Update index
      currentStyleIndex = newIndex;
      
      // Set loading state to prevent rapid switching
      if (isDressStyle) {
        carouselAnimationState.dresses = true;
        carouselAnimationState.shoes = true;
      } else {
        carouselAnimationState.shirts = true;
        carouselAnimationState.pants = true;
        carouselAnimationState.shoes = true;
      }
      
      // Load style combination
      loadStyleCombination(currentStyleIndex).then(() => {
        // Clear loading state after successful load
        carouselAnimationState.shirts = false;
        carouselAnimationState.pants = false;
        carouselAnimationState.shoes = false;
        carouselAnimationState.dresses = false;
      }).catch(err => {
        console.error('Error loading style combination:', err);
        // Clear loading state on error
        carouselAnimationState.shirts = false;
        carouselAnimationState.pants = false;
        carouselAnimationState.shoes = false;
        carouselAnimationState.dresses = false;
      });
      
      // Update style card
      updateStyleCard(currentStyleIndex);
    }
    
    // Update style card with current style metadata
    function updateStyleCard(styleIndex) {
      const styleCard = document.getElementById('style-card');
      const styleName = document.getElementById('style-name');
      const styleDescription = document.getElementById('style-description');
      const styleTotalPrice = document.getElementById('style-total-price');
      
      if (!styleCard || !styleName || !styleDescription || !styleTotalPrice) return;
      
      const metadata = styleMetadata[styleIndex];
      if (!metadata) return;
      
      // Update card content
      styleName.textContent = metadata.name;
      styleDescription.textContent = metadata.description;
      styleTotalPrice.textContent = `$${metadata.totalPrice}`;
    }
    
    // Update dresses card (similar to product cards)
    function updateDressesCard() {
      updateProductCard('dresses');
    }
    
    // applyState() - Single function that applies experience state to all UI layers
    // This is the single source of truth for UI visibility
    function applyState() {
      // Get all UI elements (three layers)
      // Layer A: Overlays
      const introOverlay = document.getElementById('intro-overlay');
      const filterOverlay = document.getElementById('filter-overlay');
      const demoModal = document.getElementById('demo-modal');
      
      // Layer B: Controls
      const primaryCarouselControl = document.getElementById('primary-carousel-control');
      const buildModeTabs = document.getElementById('build-mode-tabs');
      const shirtsControls = document.querySelector('.arrow-controls.shirts');
      const pantsControls = document.querySelector('.arrow-controls.pants');
      const shoesControls = document.querySelector('.arrow-controls.shoes');
      const dressesControls = document.querySelector('.arrow-controls.dresses');
      const stylesControls = document.querySelector('.arrow-controls.styles');
      
      // Layer C: Cards
      const productCardsContainer = document.getElementById('product-cards-container');
      const styleCard = document.getElementById('style-card');
      const productCardsBackdrop = document.getElementById('product-cards-backdrop');
      const productCardsToggle = document.getElementById('product-cards-toggle');
      const dressesCardContainer = document.getElementById('dresses-card-container');
      
      // Hide everything by default
      // Layer A: Overlays
      if (introOverlay) introOverlay.classList.add('hidden');
      if (filterOverlay) filterOverlay.classList.remove('visible');
      if (demoModal) demoModal.classList.remove('visible');
      
      // Layer B: Controls
      if (primaryCarouselControl) primaryCarouselControl.classList.remove('visible');
      if (buildModeTabs) buildModeTabs.classList.remove('visible');
      if (shirtsControls) shirtsControls.classList.remove('visible');
      if (pantsControls) pantsControls.classList.remove('visible');
      if (shoesControls) shoesControls.classList.remove('visible');
      if (dressesControls) dressesControls.classList.remove('visible');
      if (stylesControls) stylesControls.classList.remove('visible');
      
      // Layer C: Cards
      if (productCardsContainer) productCardsContainer.classList.remove('visible');
      if (styleCard) styleCard.classList.remove('visible');
      if (dressesCardContainer) dressesCardContainer.classList.remove('visible');
      if (productCardsBackdrop) productCardsBackdrop.classList.remove('visible');
      if (productCardsToggle) productCardsToggle.classList.remove('active');
      
      // Apply state based on currentExperience (single source of truth)
      if (currentExperience === 'home') {
        // Layer A: Show intro overlay
        if (introOverlay) introOverlay.classList.remove('hidden');
        
        // Layer B: Hide all controls
        // (already hidden above)
        
        // Layer C: Hide all cards
        // (already hidden above)
        
      } else if (currentExperience === 'looks') {
        // Layer A: Hide overlays
        // (already hidden above)
        
        // Layer B: Show styles arrow controls (positioned at middle like pants)
        if (stylesControls) {
          stylesControls.classList.add('visible', 'show-after-click');
        }
        
        // Layer C: Show style card (desktop) or toggle button (mobile)
        if (styleCard) {
          // On desktop, show card. On mobile, card is hidden by default, toggle button shows
          if (window.innerWidth > 768) {
            styleCard.classList.add('visible');
          } else {
            styleCard.classList.remove('visible');
          }
          updateStyleCard(currentStyleIndex);
        }
        const productCardsToggle = document.getElementById('product-cards-toggle');
        const isMobile = window.innerWidth <= 768;
        const isIPadPortrait = window.innerWidth >= 769 && window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
        if (productCardsToggle) {
          productCardsToggle.style.display = (isMobile || isIPadPortrait) ? 'flex' : 'none';
        }
        
      } else if (currentExperience === 'build') {
        // Layer A: Hide overlays
        // (already hidden above)
        
        // Layer B: Show individual arrow controls for each clothing type
        // Add show-after-click class for desktop visibility
        if (shirtsControls) {
          shirtsControls.classList.add('visible', 'show-after-click');
        }
        if (pantsControls) {
          pantsControls.classList.add('visible', 'show-after-click');
        }
        if (shoesControls) {
          shoesControls.classList.add('visible', 'show-after-click');
        }
        
        // Layer C: Show product cards (desktop) or toggle button (mobile)
        if (productCardsContainer) {
          // On desktop, show cards. On mobile, cards are hidden by default, toggle button shows
          if (window.innerWidth > 768) {
            productCardsContainer.classList.add('visible');
          } else {
            productCardsContainer.classList.remove('visible');
          }
          updateAllProductCards();
        }
        const productCardsToggle = document.getElementById('product-cards-toggle');
        const isMobile = window.innerWidth <= 768;
        const isIPadPortrait = window.innerWidth >= 769 && window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
        
        if (productCardsToggle) {
          productCardsToggle.style.display = (isMobile || isIPadPortrait) ? 'flex' : 'none';
        }
        if (productCardsBackdrop) {
          productCardsBackdrop.classList.remove('visible');
        }
        if (productCardsToggle) {
          productCardsToggle.classList.remove('active');
        }
        
      } else if (currentExperience === 'dresses') {
        // Layer A: Hide overlays
        // (already hidden above)
        
        // Layer B: Show dresses and shoes arrow controls
        if (dressesControls) {
          dressesControls.classList.add('visible', 'show-after-click');
        }
        if (shoesControls) {
          shoesControls.classList.add('visible', 'show-after-click');
        }
        
        // Layer C: Show dresses and shoes cards (desktop) or toggle button (mobile)
        if (dressesCardContainer) {
          // On desktop, show card. On mobile, card is hidden by default, toggle button shows
          if (window.innerWidth > 768) {
            dressesCardContainer.classList.add('visible');
          } else {
            dressesCardContainer.classList.remove('visible');
          }
          updateProductCardInDressesWindow('dresses');
          updateProductCardInDressesWindow('shoes');
        }
        const productCardsToggle = document.getElementById('product-cards-toggle');
        const isMobile = window.innerWidth <= 768;
        const isIPadPortrait = window.innerWidth >= 769 && window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
        if (productCardsToggle) {
          productCardsToggle.style.display = (isMobile || isIPadPortrait) ? 'flex' : 'none';
        }
      }
    }
    
    // Legacy function name for compatibility (redirects to applyState)
    function updateModeUI() {
      applyState();
    }
    
    // Update all product cards (for Collections/Build mode)
    function updateAllProductCards() {
      ['shirts', 'pants', 'shoes'].forEach(type => {
        updateProductCard(type);
      });
    }
    
    // Format file name to display name (handle underscores and special cases)
    function formatDisplayName(filename) {
      if (!filename) return '';
      
      // Remove .glb extension
      let name = filename.replace('.glb', '');
      
      // Replace underscores with spaces, but preserve brand names like UNIQLO
      // Handle special cases: UNIQLO, Nike, Adidas, etc.
      name = name.replace(/_/g, ' ');
      
      // Normalize spacing around special characters
      name = name.replace(/\s+/g, ' ').trim();
      
      // Handle special brand formatting (keep UNIQLO, Nike, Adidas as single words)
      name = name.replace(/\bUNIQLO\b/gi, 'UNIQLO');
      name = name.replace(/\bNike\b/gi, 'Nike');
      name = name.replace(/\bAdidas\b/gi, 'Adidas');
      name = name.replace(/\bLululemon\b/gi, 'Lululemon');
      name = name.replace(/\bFabletics\b/gi, 'Fabletics');
      name = name.replace(/\bAE\b/gi, 'AE');
      
      return name;
    }
    
    // Generate realistic price based on item name and type
    function generatePrice(filename, type) {
      const name = filename.toLowerCase();
      
      // Base prices by type
      const basePrices = {
        shirts: 45,
        pants: 65,
        shoes: 85,
        dresses: 120
      };
      
      let price = basePrices[type] || 50;
      
      // Adjust based on item characteristics
      // Premium brands
      if (name.includes('lululemon')) price += 45;
      if (name.includes('uniqlo')) price += 5;
      if (name.includes('fabletics')) price += 15;
      if (name.includes('nike')) price += 25;
      if (name.includes('adidas')) price += 20;
      
      // Dress-specific adjustments
      if (type === 'dresses') {
        if (name.includes('maxi')) price += 30; // Maxi dresses are premium
        if (name.includes('mini')) price -= 10; // Mini dresses slightly less
        if (name.includes('strapless')) price += 15; // Strapless dresses premium
        if (name.includes('off-shoulder') || name.includes('off_shoulder')) price += 20; // Off-shoulder style premium
        if (name.includes('boat-neck') || name.includes('boat_neck')) price += 15; // Boat neck style premium
        if (name.includes('ruffled')) price += 25; // Ruffled details premium
      }
      
      // Item-specific adjustments
      if (type === 'shirts') {
        if (name.includes('sweater')) price += 15;
        if (name.includes('jacket') || name.includes('puffer')) price += 40;
        if (name.includes('fleece')) price += 20;
        if (name.includes('tee') || name.includes('teeshirt')) price -= 15;
      }
      
      if (type === 'pants') {
        if (name.includes('dress') && name.includes('pants')) price += 25;
        if (name.includes('leggings')) price += 15;
        if (name.includes('cargo')) price += 10;
        if (name.includes('jeans')) price += 10;
        if (name.includes('suit')) price += 35;
      }
      
      if (type === 'shoes') {
        if (name.includes('oxford') || name.includes('leather')) price += 35;
        if (name.includes('heels') || name.includes('stilleto')) price += 25;
        if (name.includes('dunks')) price += 15;
        if (name.includes('basketball')) price += 20;
      }
      
      if (type === 'dresses') {
        if (name.includes('maxi')) price += 30;
        if (name.includes('mini')) price -= 15;
        if (name.includes('strapless')) price += 20;
        if (name.includes('off-shoulder') || name.includes('off_shoulder')) price += 20; // Off-shoulder style premium
        if (name.includes('boat-neck') || name.includes('boat_neck')) price += 15; // Boat neck style premium
        if (name.includes('ruffled')) price += 25; // Ruffled details premium
      }
      
      // Round to nearest 5
      price = Math.round(price / 5) * 5;
      
      return `$${price}`;
    }
    
    // Generate tags based on item name
    function generateTags(filename, type) {
      const name = filename.toLowerCase();
      const tags = [];
      
      // Type-based tags
      if (type === 'shirts') {
        if (name.includes('sweater')) tags.push('Sweater');
        if (name.includes('jacket') || name.includes('puffer') || name.includes('fleece')) tags.push('Outerwear');
        if (name.includes('tee') || name.includes('teeshirt')) tags.push('Casual');
        if (name.includes('button') || name.includes('dress')) tags.push('Formal');
      }
      
      if (type === 'pants') {
        if (name.includes('dress')) tags.push('Dress');
        if (name.includes('jeans')) tags.push('Denim');
        if (name.includes('leggings')) tags.push('Active');
        if (name.includes('cargo')) tags.push('Casual');
        if (name.includes('suit')) tags.push('Formal');
      }
      
      if (type === 'shoes') {
        if (name.includes('oxford') || name.includes('leather')) tags.push('Dress');
        if (name.includes('heels')) tags.push('Heels');
        if (name.includes('dunks') || name.includes('basketball')) tags.push('Sneakers');
      }
      
      if (type === 'dresses') {
        if (name.includes('maxi')) tags.push('Maxi');
        if (name.includes('mini')) tags.push('Mini');
        if (name.includes('strapless')) tags.push('Strapless');
        if (name.includes('ruffled')) tags.push('Ruffled');
        if (name.includes('off-shoulder') || name.includes('off_shoulder')) tags.push('Off-Shoulder');
        if (name.includes('boat-neck') || name.includes('boat_neck')) tags.push('Boat Neck');
        if (name.includes('scoopneck') || name.includes('scoop_neck')) tags.push('Scoop Neck');
      }
      
      // Brand tags
      if (name.includes('uniqlo')) tags.push('UNIQLO');
      if (name.includes('nike')) tags.push('Nike');
      if (name.includes('adidas')) tags.push('Adidas');
      if (name.includes('lululemon')) tags.push('Lululemon');
      if (name.includes('fabletics')) tags.push('Fabletics');
      
      return tags.slice(0, 3); // Limit to 3 tags
    }
    
    // Update a single product card with current item info
    function updateProductCard(type) {
      const card = document.getElementById(`product-card-${type}`);
      const nameEl = document.getElementById(`product-name-${type}`);
      const tagsEl = document.getElementById(`product-tags-${type}`);
      const priceEl = document.getElementById(`product-price-${type}`);

      if (!card || !nameEl || !tagsEl || !priceEl) return;

      // Get current item info
      const currentIndex = current[type] || 0;
      const url = assets[type] && assets[type][currentIndex] ? assets[type][currentIndex] : '';
      const filename = url ? url.split('/').pop() : '';

      // Format display name
      const itemName = formatDisplayName(filename);

      // Generate price and tags
      const price = generatePrice(filename, type);
      const tags = generateTags(filename, type);

      // Update card
      nameEl.textContent = itemName;
      priceEl.textContent = price;

      // Update tags
      tagsEl.innerHTML = '';
      tags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'product-tag';
        tagEl.textContent = tag;
        tagsEl.appendChild(tagEl);
      });
    }

    // Helper function to update product card in dresses window (handles special IDs)
    function updateProductCardInDressesWindow(type) {
      const suffix = type === 'shoes' ? '-dresses' : '';
      const card = document.getElementById(`product-card-${type}${suffix}`);
      const nameEl = document.getElementById(`product-name-${type}${suffix}`);
      const tagsEl = document.getElementById(`product-tags-${type}${suffix}`);
      const priceEl = document.getElementById(`product-price-${type}${suffix}`);

      if (!card || !nameEl || !tagsEl || !priceEl) return;

      // Get current item info
      const currentIndex = current[type] || 0;
      const url = assets[type] && assets[type][currentIndex] ? assets[type][currentIndex] : '';
      const filename = url ? url.split('/').pop() : '';

      // Format display name
      const itemName = formatDisplayName(filename);

      // Generate price and tags
      const price = generatePrice(filename, type);
      const tags = generateTags(filename, type);

      // Update card
      nameEl.textContent = itemName;
      priceEl.textContent = price;

      // Update tags
      tagsEl.innerHTML = '';
      tags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'product-tag';
        tagEl.textContent = tag;
        tagsEl.appendChild(tagEl);
      });
    }

    function switchItem(type, dir) {
      // Handle styles mode separately
      if (type === 'styles') {
        switchStyle(dir);
        return;
      }
      
      if (carouselAnimationState[type]) return; // Don't allow switching during loading
      
      const total = assets[type].length;
      const newIndex = (current[type] + dir + total) % total;
      current[type] = newIndex;
      
      // Simply load the new item directly - no animation
      carouselAnimationState[type] = true;
      loadAllCarouselItems(type).then(() => {
        // Rotation persists (handled by rotationController)
        carouselAnimationState[type] = false;
        
        // Update product cards if in build mode or dresses mode
        if (currentExperience === 'build') {
          updateProductCard(type);
        } else if (currentExperience === 'dresses') {
          if (type === 'dresses' || type === 'shoes') {
            updateProductCardInDressesWindow(type);
          }
        }
      });
    }
    
    // Mode switching function
    function switchMode() {
      if (currentMode === 'casual') {
        // Switch to dresses mode
        currentMode = 'dresses';
        
        // Hide shirts and pants
        if (groups.shirts) groups.shirts.visible = false;
        if (groups.pants) groups.pants.visible = false;
        if (groups.shoes) groups.shoes.visible = true; // Keep shoes visible
        
        // Show and load dresses
        if (groups.dresses) groups.dresses.visible = true;
        
        // Load first dress
        if (assets.dresses && assets.dresses.length > 0) {
          current.dresses = 0;
          carouselAnimationState['dresses'] = true;
          loadAllCarouselItems('dresses').then(() => {
            carouselRotationState['dresses'] = 0;
            carouselGroups['dresses'].rotation.y = 0;
            carouselAnimationState['dresses'] = false;
          }).catch(err => {
            console.error('Error loading dresses:', err);
            carouselAnimationState['dresses'] = false;
          });
        }
      } else {
        // Switch to casual mode
        currentMode = 'casual';
        
        // Hide dresses
        if (groups.dresses) groups.dresses.visible = false;
        
        // Show shirts and pants
        if (groups.shirts) groups.shirts.visible = true;
        if (groups.pants) groups.pants.visible = true;
        if (groups.shoes) groups.shoes.visible = true;
        
        // Reload shirts and pants
        if (assets.shirts && assets.shirts.length > 0) {
          carouselAnimationState['shirts'] = true;
          loadAllCarouselItems('shirts').then(() => {
            carouselRotationState['shirts'] = 0;
            carouselGroups['shirts'].rotation.y = 0;
            carouselAnimationState['shirts'] = false;
          }).catch(err => {
            console.error('Error loading shirts:', err);
            carouselAnimationState['shirts'] = false;
          });
        }
        if (assets.pants && assets.pants.length > 0) {
          carouselAnimationState['pants'] = true;
          loadAllCarouselItems('pants').then(() => {
            carouselRotationState['pants'] = 0;
            carouselGroups['pants'].rotation.y = 0;
            carouselAnimationState['pants'] = false;
          }).catch(err => {
            console.error('Error loading pants:', err);
            carouselAnimationState['pants'] = false;
          });
        }
      }
      
      // Update UI after a brief delay to ensure visibility changes
      setTimeout(() => {
        updateModeUI();
      }, 10);
    }

    // Arrow button event listeners (works for all clothing types including styles)
    document.querySelectorAll('.arrow-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.type;
        const dir = parseInt(btn.dataset.dir);
        
        if (type === 'styles') {
          switchStyle(dir);
        } else {
          switchItem(type, dir);
        }
      });
    });
    
    // Build mode tabs event listeners
    document.querySelectorAll('.build-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabType = tab.dataset.tab;
        switchBuildTab(tabType);
      });
    });
    
    // Switch build mode tab
    function switchBuildTab(tabType) {
      currentBuildTab = tabType;
      
      // Update active tab
      document.querySelectorAll('.build-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabType) {
          tab.classList.add('active');
        }
      });
      
      // Show all clothing types (full try-on mode)
      if (groups.shirts) groups.shirts.visible = true;
      if (groups.pants) groups.pants.visible = true;
      if (groups.shoes) groups.shoes.visible = true;
      
      // Update all product cards
      if (currentExperience === 'build') {
        updateAllProductCards();
      }
    }
    
    // Mode button removed - navigation now handled by top nav
    
    // Single source of truth for experience state
    function setExperience(experience) {
      currentExperience = experience;
      
      // Reset camera and controls to initial state when switching experiences
      resetCameraAndControls();

      if (experience === 'home') {
        // Reset to initial state
        restoreOriginalAssets();
        currentStyleIndex = 0;
        currentSelectedClothing = 'shirts';
        
        // Hide all clothing groups
        if (groups.shirts) groups.shirts.visible = false;
        if (groups.pants) groups.pants.visible = false;
        if (groups.shoes) groups.shoes.visible = false;
        if (groups.dresses) groups.dresses.visible = false;
        
        // Reset position to center
        clothingGroup.position.x = targetCenterX;
        clothingGroup.position.y = targetCenterY;
        clothingGroup.rotation.y = 0;
        
      } else if (experience === 'looks') {
        // Curated outfits (styles mode)
        restoreOriginalAssets();
        currentStyleIndex = 0;
        
        // Check what the first style is and set visibility accordingly
        const firstStyle = styleCombinations[0];
        const isDressStyle = firstStyle.dress !== undefined && firstStyle.dress >= 0;
        
        // Set visibility based on first style type
        if (isDressStyle) {
          if (groups.shirts) groups.shirts.visible = false;
          if (groups.pants) groups.pants.visible = false;
          if (groups.dresses) groups.dresses.visible = true;
          if (groups.shoes) groups.shoes.visible = true;
        } else {
          if (groups.shirts) groups.shirts.visible = true;
          if (groups.pants) groups.pants.visible = true;
          if (groups.shoes) groups.shoes.visible = true;
          if (groups.dresses) groups.dresses.visible = false;
        }
        
        // Load first style combination
        loadStyleCombination(currentStyleIndex).catch(err => {
          console.error('Error loading style combination:', err);
        });
        
        // Update style card
        updateStyleCard(currentStyleIndex);
        
      } else if (experience === 'build') {
        // Collection mode (no filter, just browse items)
        randomizeAssets();
        currentBuildTab = 'shirts';
        currentSelectedClothing = 'shirts';
        
        // Show all clothing types (full try-on mode)
        if (groups.shirts) groups.shirts.visible = true;
        if (groups.pants) groups.pants.visible = true;
        if (groups.shoes) groups.shoes.visible = true;
        if (groups.dresses) groups.dresses.visible = false;
        
        // Load all items
        ["shirts", "pants", "shoes"].forEach((type) => {
          if (assets[type] && assets[type].length > 0) {
            current[type] = 0;
            loadAllCarouselItems(type, false);
          }
        });
        
      } else if (experience === 'dresses') {
        // Dresses mode
        // Hide shirts and pants, show dresses and shoes
        if (groups.shirts) groups.shirts.visible = false;
        if (groups.pants) groups.pants.visible = false;
        if (groups.dresses) groups.dresses.visible = true;
        if (groups.shoes) groups.shoes.visible = true;
        
        // Load first dress
        if (assets.dresses && assets.dresses.length > 0) {
          current.dresses = 0;
          carouselAnimationState['dresses'] = true;
          loadAllCarouselItems('dresses').then(() => {
            carouselAnimationState['dresses'] = false;
          }).catch(err => {
            console.error('Error loading dresses:', err);
            carouselAnimationState['dresses'] = false;
          });
        }
      }
      
      // Apply UI state (three layers: Overlays, Controls, Cards)
      applyState();
    }
    
    
    // Top navigation handlers - use setExperience as single source of truth
    const navStyles = document.getElementById('nav-styles');
    const navCollection = document.getElementById('nav-collection');
    const navDresses = document.getElementById('nav-dresses');
    
    if (navStyles) {
      navStyles.addEventListener('click', (e) => {
        e.preventDefault();
        setExperience('looks');
      });
    }
    
    if (navCollection) {
      navCollection.addEventListener('click', (e) => {
        e.preventDefault();
        setExperience('build');
      });
    }
    
    if (navDresses) {
      navDresses.addEventListener('click', (e) => {
        e.preventDefault();
        setExperience('dresses');
      });
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
    window.addEventListener("resize", onResize);

    // Intro overlay setup
    const introOverlay = document.getElementById("intro-overlay");
    const introStartButton = document.getElementById("intro-start-button");
    
    // Cards toggle functionality (mobile/narrow screens) - works for collections, styles, and dresses
    const productCardsToggle = document.getElementById('product-cards-toggle');
    const productCardsContainer = document.getElementById('product-cards-container');
    const productCardsBackdrop = document.getElementById('product-cards-backdrop');
    const styleCard = document.getElementById('style-card');
    const dressesCardContainer = document.getElementById('dresses-card-container');
    
    if (productCardsToggle) {
      let cardsOpen = false;
      
      function toggleCards() {
        cardsOpen = !cardsOpen;
        const isMobile = window.innerWidth <= 768;
        const isIPadPortrait = window.innerWidth >= 769 && window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
        
        if (cardsOpen && (isMobile || isIPadPortrait)) {
          // Show appropriate cards based on current experience
          if (currentExperience === 'build' && productCardsContainer) {
            productCardsContainer.classList.add('visible');
          } else if (currentExperience === 'looks' && styleCard) {
            styleCard.classList.add('visible');
          } else if (currentExperience === 'dresses' && dressesCardContainer) {
            dressesCardContainer.classList.add('visible');
          }
          if (productCardsBackdrop) productCardsBackdrop.classList.add('visible');
          productCardsToggle.classList.add('active');
        } else {
          // Hide cards
          if (productCardsContainer) productCardsContainer.classList.remove('visible');
          if (styleCard) styleCard.classList.remove('visible');
          if (dressesCardContainer) dressesCardContainer.classList.remove('visible');
          if (productCardsBackdrop) productCardsBackdrop.classList.remove('visible');
          productCardsToggle.classList.remove('active');
        }
      }
      
      productCardsToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleCards();
      });
      
      if (productCardsBackdrop) {
        productCardsBackdrop.addEventListener('click', () => {
          if (cardsOpen) {
            toggleCards();
          }
        });
      }
      
      // Update toggle button visibility on resize
      window.addEventListener('resize', () => {
        const isMobile = window.innerWidth <= 768;
        const isIPadPortrait = window.innerWidth >= 769 && window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
        
        if (isMobile || isIPadPortrait) {
          // Mobile/iPad: show toggle, hide cards by default unless manually opened
          productCardsToggle.style.display = 'flex';
          if (!cardsOpen) {
            if (productCardsContainer) productCardsContainer.classList.remove('visible');
            if (styleCard) styleCard.classList.remove('visible');
            if (dressesCardContainer) dressesCardContainer.classList.remove('visible');
            if (productCardsBackdrop) productCardsBackdrop.classList.remove('visible');
          }
        } else {
          // Desktop: hide toggle, show cards normally
          productCardsToggle.style.display = 'none';
          if (productCardsBackdrop) productCardsBackdrop.classList.remove('visible');
          productCardsToggle.classList.remove('active');
          cardsOpen = false;
        }
      });
    }
    
    
    // Demo modal setup
    const demoModal = document.getElementById("demo-modal");
    const requestDemoButton = document.getElementById("request-demo-button");
    const demoModalClose = document.getElementById("demo-modal-close");
    const demoModalCancel = document.getElementById("demo-modal-cancel");
    const demoForm = document.getElementById("demo-form");
    const demoEmailInput = document.getElementById("demo-email");
    
    // Show demo modal
    if (requestDemoButton) {
      requestDemoButton.addEventListener("click", (e) => {
        e.preventDefault();
        if (demoModal) demoModal.classList.add("visible");
        if (demoEmailInput) demoEmailInput.focus();
      });
    }
    
    // Close demo modal and reset form state
    function closeDemoModal() {
      if (demoModal) demoModal.classList.remove("visible");
      if (demoEmailInput) demoEmailInput.value = "";
      
      // Reset form to initial state
      const formContent = document.getElementById('demo-form-content');
      const successMessage = document.getElementById('demo-success-message');
      const submitButton = document.getElementById('demo-submit-button');
      const modalTitle = document.getElementById('demo-modal-title');
      const modalSubtitle = document.getElementById('demo-modal-subtitle');
      
      if (formContent) formContent.classList.remove('hidden');
      if (successMessage) successMessage.classList.add('hidden');
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = 'Send';
      }
      if (modalTitle) modalTitle.textContent = 'Request a Demo';
      if (modalSubtitle) modalSubtitle.textContent = "We'll get back to you soon";
    }
    
    if (demoModalClose) {
      demoModalClose.addEventListener("click", closeDemoModal);
    }
    
    if (demoModalCancel) {
      demoModalCancel.addEventListener("click", closeDemoModal);
    }
    
    // Close modal when clicking outside
    if (demoModal) {
      demoModal.addEventListener("click", (e) => {
        if (e.target === demoModal) {
          closeDemoModal();
        }
      });
    }
    
    // Demo form submission - submit to Formspree using fetch
    if (demoForm) {
      demoForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const email = demoEmailInput.value.trim();
        if (!email) return;
        
        const submitButton = document.getElementById('demo-submit-button');
        const formContent = document.getElementById('demo-form-content');
        const successMessage = document.getElementById('demo-success-message');
        const modalTitle = document.getElementById('demo-modal-title');
        const modalSubtitle = document.getElementById('demo-modal-subtitle');
        
        // Disable submit button
        if (submitButton) submitButton.disabled = true;
        if (submitButton) submitButton.textContent = 'Sending...';
        
        try {
          const response = await fetch('https://formspree.io/f/xkoonvzb', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ email: email })
          });
          
          if (response.ok) {
            // Show success state
            if (formContent) formContent.classList.add('hidden');
            if (successMessage) successMessage.classList.remove('hidden');
            if (modalTitle) modalTitle.textContent = 'Thank you!';
            if (modalSubtitle) modalSubtitle.textContent = '';
            
            // Close modal after 2 seconds
            setTimeout(() => {
              closeDemoModal();
            }, 2000);
          } else {
            throw new Error('Form submission failed');
          }
        } catch (error) {
          console.error('Error submitting form:', error);
          // Re-enable button and show error
          if (submitButton) submitButton.disabled = false;
          if (submitButton) submitButton.textContent = 'Send';
          alert('Sorry, there was an error submitting your request. Please try again.');
        }
      });
    }
    
    // Intro start button handler - default to looks mode
    if (introStartButton) {
      introStartButton.addEventListener("click", () => {
        setExperience('looks');
      });
    }
    
    let isAnimating = false;
    const animationDuration = 1200; // milliseconds
    let animationStartTime = null;
    let initialRotationValue = 0; // will be set when button is clicked
    
    function startAnimation() {
      // No animation - items stay in center
      // Just ensure position is centered
      clothingGroup.position.x = targetCenterX;
      clothingGroup.position.y = targetCenterY;
      clothingGroup.rotation.y = 0;

      // Load items directly based on experience
      if (currentExperience === 'looks') {
        loadStyleCombination(currentStyleIndex).catch(err => {
          console.error('Error loading style combination:', err);
        });
      } else if (currentExperience === 'build') {
        ["shirts", "pants", "shoes"].forEach((type) => {
          if (assets[type] && assets[type].length > 0) {
            loadAllCarouselItems(type, false);
          }
        });
      }

      // Apply UI state
      applyState();
    }
    
    // Legacy button handlers removed - navigation now handled by intro overlay
    
    // Helper function to shuffle array (Fisher-Yates algorithm)
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }
    
    // Function to randomize asset order (keep first item, shuffle the rest)
    function randomizeAssets() {
      // Keep first item, shuffle the rest
      function shuffleFromSecond(array) {
        if (array.length <= 1) return [...array];
        const first = array[0];
        const rest = shuffleArray([...array.slice(1)]);
        return [first, ...rest];
      }
      
      assets.shirts = shuffleFromSecond(originalAssets.shirts);
      assets.pants = shuffleFromSecond(originalAssets.pants);
      assets.shoes = shuffleFromSecond(originalAssets.shoes);
      
      // Reset current indices to start from the beginning
      current.shirts = 0;
      current.pants = 0;
      current.shoes = 0;
      
      console.log("Assets randomized for free browse mode (first item preserved)");
    }
    
    // Function to restore original asset order
    function restoreOriginalAssets() {
      assets.shirts = [...originalAssets.shirts];
      assets.pants = [...originalAssets.pants];
      assets.shoes = [...originalAssets.shoes];
      
      current.shirts = 0;
      current.pants = 0;
      current.shoes = 0;
    }
    
    // Filter assets based on selected filters
    function applyFilters() {
      restoreOriginalAssets();
      
      // Filter shirts based on tops selection
      if (selectedFilters.tops.length > 0) {
        assets.shirts = originalAssets.shirts.filter(url => {
          const filename = url.split('/').pop().toLowerCase();
          return selectedFilters.tops.some(filter => filename.includes(filter));
        });
      } else {
        // If no filters selected for tops, show no items
        assets.shirts = [];
      }
      
      // Filter pants based on bottoms selection (including shorts)
      if (selectedFilters.bottoms.length > 0) {
        // Get all bottoms items (pants + shorts from manifest)
        const allBottoms = [...originalAssets.pants];
        if (manifest.shorts) {
          manifest.shorts.forEach(file => {
            allBottoms.push(u(`shorts/${file}`));
          });
        }
        
        assets.pants = allBottoms.filter(url => {
          const filename = url.split('/').pop().toLowerCase();
          return selectedFilters.bottoms.some(filter => {
            if (filter === 'pants') {
              // Match pants but not shorts, skirts, jeans, leggings
              return filename.includes('pant') && 
                     !filename.includes('short') && 
                     !filename.includes('skirt') && 
                     !filename.includes('jean') && 
                     !filename.includes('legging');
            }
            if (filter === 'shorts') {
              return filename.includes('short');
            }
            if (filter === 'skirts') {
              return filename.includes('skirt');
            }
            if (filter === 'jeans') {
              return filename.includes('jean');
            }
            if (filter === 'leggings') {
              return filename.includes('legging');
            }
            return filename.includes(filter);
          });
        });
      } else {
        // If no filters selected for bottoms, show no items
        assets.pants = [];
      }
      
      // Filter shoes based on shoes selection
      if (selectedFilters.shoes.length > 0) {
        assets.shoes = originalAssets.shoes.filter(url => {
          const filename = url.split('/').pop().toLowerCase();
          return selectedFilters.shoes.some(filter => {
            if (filter === 'basketball') return filename.includes('basketball');
            if (filter === 'tennis') return filename.includes('tennis');
            if (filter === 'dress') return filename.includes('dress');
            if (filter === 'dunks') return filename.includes('dunk');
            return false;
          });
        });
      } else {
        // If no filters selected for shoes, show no items
        assets.shoes = [];
      }
      
      // Reset current indices
      current.shirts = 0;
      current.pants = 0;
      current.shoes = 0;
      
      // Hide groups for categories with no items (empty filters) and clear their slots
      if (assets.shirts.length === 0) {
        if (groups.shirts) groups.shirts.visible = false;
        // Clear the carousel slots for shirts
        carouselSlots.shirts.prev.clear();
        carouselSlots.shirts.current.clear();
        carouselSlots.shirts.next.clear();
      } else {
        if (groups.shirts) groups.shirts.visible = true;
      }
      
      if (assets.pants.length === 0) {
        if (groups.pants) groups.pants.visible = false;
        // Clear the carousel slots for pants
        carouselSlots.pants.prev.clear();
        carouselSlots.pants.current.clear();
        carouselSlots.pants.next.clear();
      } else {
        if (groups.pants) groups.pants.visible = true;
      }
      
      if (assets.shoes.length === 0) {
        if (groups.shoes) groups.shoes.visible = false;
        // Clear the carousel slots for shoes
        carouselSlots.shoes.prev.clear();
        carouselSlots.shoes.current.clear();
        carouselSlots.shoes.next.clear();
      } else {
        if (groups.shoes) groups.shoes.visible = true;
      }
    }
    
    // Store filter option click handlers to avoid duplicates
    let filterOptionHandlers = new Map();
    
    // Filter label mapping
    const filterLabels = {
      'shirt': 'Shirts',
      'jacket': 'Jackets',
      'shorts': 'Shorts',
      'skirt': 'Skirts',
      'jeans': 'Jeans',
      'leggings': 'Leggings',
      'pants': 'Pants',
      'basketball': 'Basketball',
      'tennis': 'Tennis',
      'dress': 'Dress',
      'dunks': 'Dunks'
    };
    
    // Update selected filters display
    function updateSelectedFiltersDisplay() {
      const selectedContainer = document.getElementById('filter-selected');
      const selectedItems = document.getElementById('filter-selected-items');
      if (!selectedContainer || !selectedItems) return;
      
      // Collect all selected filters
      const allSelected = [];
      if (selectedFilters.tops.length > 0) {
        allSelected.push('Tops: ' + selectedFilters.tops.map(f => filterLabels[f] || f).join(', '));
      }
      if (selectedFilters.bottoms.length > 0) {
        allSelected.push('Bottoms: ' + selectedFilters.bottoms.map(f => filterLabels[f] || f).join(', '));
      }
      if (selectedFilters.shoes.length > 0) {
        allSelected.push('Shoes: ' + selectedFilters.shoes.map(f => filterLabels[f] || f).join(', '));
      }
      
      // Clear existing tags
      selectedItems.innerHTML = '';
      
      if (allSelected.length > 0) {
        selectedContainer.classList.remove('empty');
        allSelected.forEach(item => {
          const tag = document.createElement('div');
          tag.className = 'filter-selected-tag';
          tag.textContent = item;
          selectedItems.appendChild(tag);
        });
      } else {
        selectedContainer.classList.add('empty');
      }
    }
    
    // Initialize filter UI
    function initializeFilterUI(resetFilters = false) {
      const filterOverlay = document.getElementById('filter-overlay');
      const filterOptions = document.querySelectorAll('.filter-option');
      const applyButton = document.getElementById('apply-filters-button');
      const resetButton = document.getElementById('reset-filters-button');
      
      // Only reset filter selections if explicitly requested (not when restoring)
      if (resetFilters) {
        selectedFilters = { tops: [], bottoms: [], shoes: [] };
      }
      
      // Clear all selected states
      filterOptions.forEach(option => {
        option.classList.remove('selected');
        // Remove old listener if it exists
        if (filterOptionHandlers.has(option)) {
          option.removeEventListener('click', filterOptionHandlers.get(option));
        }
      });
      
      // Add click handlers to filter options (only once)
      filterOptions.forEach(option => {
        const handler = () => {
          const filterValue = option.dataset.filter;
          const category = option.closest('.filter-category').querySelector('h3').textContent.toLowerCase();
          
          // Determine which filter array to use
          let filterArray;
          if (category === 'tops') {
            filterArray = selectedFilters.tops;
          } else if (category === 'bottoms') {
            filterArray = selectedFilters.bottoms;
          } else if (category === 'shoes') {
            filterArray = selectedFilters.shoes;
          } else {
            return;
          }
          
          // Toggle selection
          if (option.classList.contains('selected')) {
            option.classList.remove('selected');
            const index = filterArray.indexOf(filterValue);
            if (index > -1) filterArray.splice(index, 1);
          } else {
            option.classList.add('selected');
            filterArray.push(filterValue);
          }
          
          // Update selected filters display
          updateSelectedFiltersDisplay();
        };
        
        option.addEventListener('click', handler);
        filterOptionHandlers.set(option, handler);
      });
      
      // Reset button handler
      if (resetButton && !resetButton._resetHandler) {
        resetButton._resetHandler = () => {
          selectedFilters = { tops: [], bottoms: [], shoes: [] };
          filterOptions.forEach(option => {
            option.classList.remove('selected');
          });
          updateSelectedFiltersDisplay();
        };
        resetButton.addEventListener('click', resetButton._resetHandler);
      }
      
      // Remove old apply button listener if it exists
      if (applyButton && applyButton._applyHandler) {
        applyButton.removeEventListener('click', applyButton._applyHandler);
      }
      
      // Apply filters button handler
      const applyHandler = () => {
        // Store current filter selections before applying
        lastAppliedFilters = {
          tops: [...selectedFilters.tops],
          bottoms: [...selectedFilters.bottoms],
          shoes: [...selectedFilters.shoes]
        };
        
        // Apply filters
        applyFilters();
        
        // Hide filter overlay
        filterOverlay.classList.remove('visible');
        
        // Show clothing items view
        // Switch to build mode
        setExperience('build');
      };
      
      if (applyButton) {
        applyButton._applyHandler = applyHandler;
        applyButton.addEventListener('click', applyHandler);
      }
      
      // Update selected filters display
      updateSelectedFiltersDisplay();
    }
    
    // Restore filter selections from last applied filters
    function restoreFilterSelections() {
      selectedFilters = {
        tops: [...lastAppliedFilters.tops],
        bottoms: [...lastAppliedFilters.bottoms],
        shoes: [...lastAppliedFilters.shoes]
      };
      
      // Update UI to show selected filters
      document.querySelectorAll('.filter-option').forEach(option => {
        option.classList.remove('selected');
        const filterValue = option.dataset.filter;
        const category = option.closest('.filter-category').querySelector('h3').textContent.toLowerCase();
        
        let filterArray;
        if (category === 'tops') {
          filterArray = selectedFilters.tops;
        } else if (category === 'bottoms') {
          filterArray = selectedFilters.bottoms;
        } else if (category === 'shoes') {
          filterArray = selectedFilters.shoes;
        } else {
          return;
        }
        
        if (filterArray.includes(filterValue)) {
          option.classList.add('selected');
        }
      });
      
      // Update selected filters display
      updateSelectedFiltersDisplay();
    }
    
    // Show filter overlay
    function showFilterOverlay() {
      const filterOverlay = document.getElementById('filter-overlay');
      if (filterOverlay) {
        filterOverlay.classList.add('visible');
        // Reset filters and initialize UI (fresh start from menu)
        selectedFilters = { tops: [], bottoms: [], shoes: [] };
        lastAppliedFilters = { tops: [], bottoms: [], shoes: [] };
        initializeFilterUI(true);
      }
    }
    
    // Hide filter overlay
    function hideFilterOverlay() {
      const filterOverlay = document.getElementById('filter-overlay');
      if (filterOverlay) {
        filterOverlay.classList.remove('visible');
      }
    }
    
    // Legacy button handlers removed - navigation now handled by intro overlay
    
    // Legacy go button handler removed

    // Initialize: load initial models
    // Verify we have assets before loading
    const hasAssets = Object.values(assets).some(arr => arr.length > 0);
    if (hasAssets) {
      // Both mobile and desktop: show welcome screen, load initial models
      // On mobile, welcome screen is full screen
      // On desktop, it's half screen
      ["shirts", "pants", "shoes"].forEach((type) => {
        if (assets[type] && assets[type].length > 0) {
          loadModel(type, 0);
        }
      });
      // Initialize mode UI
      updateModeUI();
    } else {
      console.error("No assets found in manifest.");
    }

    // Store current models for rotation control
    const currentModels = {
      shirts: null,
      pants: null,
      shoes: null,
      dresses: null
    };
    
    function animate() {
      requestAnimationFrame(animate);
      
      // Increment global angle once per frame (not per item)
      if (rotationController.enabled) {
        rotationController.increment();
      }
      
      // Apply rotation to current visible models (not groups)
      ['shirts', 'pants', 'shoes', 'dresses'].forEach(type => {
        if (rotationController.enabled && currentModels[type] && groups[type] && groups[type].visible) {
          // Apply rotation to the model itself (first child in current slot)
          const currentSlot = carouselSlots[type].current;
          if (currentSlot && currentSlot.children.length > 0) {
            const model = currentSlot.children[0];
            if (model && model.isObject3D) {
              model.rotation.y = rotationController.getAngle(); // Apply global angle
            }
          }
        }
      });
      
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>

